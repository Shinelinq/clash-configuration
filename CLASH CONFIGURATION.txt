// ================= 0. å…¨å±€å¸¸é‡å®šä¹‰ (è¿™æ˜¯ä½ çš„â€œæˆ˜æœ¯æŒ‡æŒ¥ä¸­å¿ƒâ€) =================

// ä»£ç†æ€»å‡ºå£åç§°ï¼šæ‰€æœ‰çš„è§„åˆ™æ²¡åŒ¹é…åˆ°çš„ï¼Œæˆ–è€…é€‰äº† PROXY çš„ï¼Œæœ€åŽéƒ½æµå‘è¿™é‡Œ
const PROXY_NAME = "Proxy";

// æµ‹é€Ÿè®¾ç½®ï¼šè¿™æ˜¯ç»™èŠ‚ç‚¹â€œä½“æ£€â€çš„æ ‡å‡†
const TEST_URL = "https://cp.cloudflare.com/generate_204"; // ç»å…¸çš„ CF æµ‹é€Ÿåœ°å€ï¼Œè½»é‡
const TEST_INTERVAL = 300; // æ¯ 300 ç§’ï¼ˆ5åˆ†é’Ÿï¼‰æµ‹ä¸€æ¬¡ï¼Œä¸è‡³äºŽæŠŠæœºåœºè·‘å´©
const TEST_TOLERANCE = 50; // å®¹å·® 50msï¼Œé˜²æ­¢èŠ‚ç‚¹å› ä¸ºå¾®å°æ³¢åŠ¨é¢‘ç¹åˆ‡æ¢

// è§„åˆ™é›†é…ç½®æ¸…å•ï¼šè¿™æ˜¯ä½ çš„â€œçº¢ç»¿ç¯â€ç­–ç•¥è¡¨
// å·¦è¾¹æ˜¯ç­–ç•¥ç»„åå­—ï¼Œå³è¾¹æ˜¯é»˜è®¤ç­–ç•¥ (DIRECT=ç›´è¿ž, PROXY=èµ°ä»£ç†)
const RULE_CONFIG = {
    // --- é»˜è®¤ç›´è¿žç»„ (å›½å†…æœåŠ¡ï¼Œä¸æµªè´¹æµé‡) ---
    "LAN": "DIRECT",        // å±€åŸŸç½‘
    "ChinaMax": "DIRECT",   // ä¹Ÿå°±æ˜¯ GeoSite CNï¼ŒåŒ…å«å‡ ä¹Žæ‰€æœ‰å›½å†…åŸŸå
    "SteamCN": "DIRECT",    // Steam å•†åº—é¡µé¢ç­‰å›½å†…éƒ¨åˆ†
    "BiliBili": "DIRECT",   // Bç«™ç›´è¿žï¼ˆé™¤éžä½ è¦çœ‹æ¸¯æ¾³å°é™å®šï¼‰
    "Apple": "DIRECT",      // è‹¹æžœæœåŠ¡ï¼Œå›½å†…é€šå¸¸ç›´è¿žæ›´å¿«
    
    // --- é»˜è®¤ä»£ç†ç»„ (å›½å¤–æœåŠ¡ï¼Œå¿…é¡»ç¿»å¢™) ---
    "OpenAI": "PROXY",      // ChatGPT
    "Netflix": "PROXY",     // å¥¶é£ž
    "Disney": "PROXY",      // è¿ªå£«å°¼+
    "TikTok": "PROXY",      // å›½é™…ç‰ˆæŠ–éŸ³
    "Steam": "PROXY",       // Steam ç¤¾åŒº/è”æœºéƒ¨åˆ†
    "Telegram": "PROXY",    // ç”µæŠ¥
    "Google": "PROXY",      // è°·æ­Œå…¨å®¶æ¡¶
    "Microsoft": "PROXY",   // å¾®è½¯ (æœ‰æ—¶éœ€è¦ä»£ç†åŠ é€Ÿ)
    "PayPal": "PROXY",      // æ”¯ä»˜
    "GlobalMedia": "PROXY"  // å…¶ä»–å›½å¤–æµåª’ä½“
};

// ================= 1. ä¸»å‡½æ•°å…¥å£ (è¿™æ˜¯è„šæœ¬çš„å¤§è„‘) =================
// Clash Verge å¯åŠ¨æ—¶ä¼šæŠŠé»˜è®¤é…ç½®å¡žç»™ configï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£æŠŠ config æ”¹é€ æˆä½ è¦çš„æ ·å­
function main(config) {
    // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æžœè¿žèŠ‚ç‚¹éƒ½æ²¡æœ‰ï¼Œè¿˜æŠ˜è…¾å•¥ï¼Ÿç›´æŽ¥åŽŸè·¯è¿”å›ž
    if (!config.proxies || config.proxies.length === 0)
        return config;

    // æŽ¥ä¸‹æ¥åƒæµæ°´çº¿ä¸€æ ·åŠ å·¥é…ç½®ï¼Œé¡ºåºå¾ˆé‡è¦ï¼
    overwriteRules(config);       // 3. æžå®šåˆ†æµè§„åˆ™ (å“ªäº›åŸŸåèµ°å“ªæ¡è·¯)
    overwriteProxyGroups(config); // 4. æžå®šç­–ç•¥ç»„ (æŠŠèŠ‚ç‚¹åˆ†ç»„ï¼Œæ¯”å¦‚é¦™æ¸¯ç»„ã€ç¾Žå›½ç»„)
    overwriteDns(config);         // 5. æžå®š DNS (é˜²æ­¢ DNS æ±¡æŸ“ï¼Œæ ¸å¿ƒä¸­çš„æ ¸å¿ƒ)
    addCustomRules(config);       // 2. æ’å…¥ä½ çš„ç§è´§ (æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™)

    return config; // æŠŠæ”¹å¥½çš„é…ç½®äº¤è¿˜ç»™å†…æ ¸
}

// ================= 2. è‡ªå®šä¹‰è§„åˆ™ (è¿™æ˜¯ VIP å¿«é€Ÿé€šé“) =================
function addCustomRules(config) {
    const customRules = [
        // ç¤ºä¾‹ï¼šåœ¨è¿™é‡Œå†™çš„è§„åˆ™ä¼šæ’åœ¨æœ€å‰é¢ï¼Œä¼˜å…ˆçº§æœ€é«˜
        // å¦‚æžœä½ æƒ³å¼ºåˆ¶ notion èµ°ç¾Žå›½ï¼Œå°±åœ¨è¿™å†™
        // "RULE-SET,Google,ðŸ‡ºðŸ‡¸ United States",
    ];
    // æŠŠä½ çš„ç§è´§æ”¾åˆ°åŽŸæœ‰è§„åˆ™åˆ—è¡¨çš„å¤´éƒ¨
    config["rules"] = [...customRules, ...config["rules"]];
}

// ================= 3. è¦†å†™è§„åˆ™ & Providers (è¿™æ˜¯ä½ çš„â€œå¤–åŒ…å›¢é˜Ÿâ€) =================
function overwriteRules(params) {
    // 3.1 è§„åˆ™é›† URL æ˜ å°„è¡¨ï¼šè¿™é‡Œå¼•ç”¨äº† blackmatrix7 å¤§ä½¬ç»´æŠ¤çš„è§„åˆ™æ–‡ä»¶
    // å®ƒä»¬åŒ…å«äº†æˆåƒä¸Šä¸‡æ¡åŸŸåï¼Œä¸ç”¨ä½ è‡ªå·±æ‰‹å†™
    const ruleUrlMap = {
        "LAN": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan_No_Resolve.yaml",
        "ChinaMax": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaMax/ChinaMax_Classical_No_IPv6_No_Resolve.yaml",
        "SteamCN": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN_No_Resolve.yaml",
        "BiliBili": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/BiliBili/BiliBili_No_Resolve.yaml",
        "Apple": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Apple/Apple_Classical_No_Resolve.yaml",
        "OpenAI": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI_No_Resolve.yaml",
        "Netflix": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Netflix/Netflix_No_Resolve.yaml",
        "Disney": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Disney/Disney_No_Resolve.yaml",
        "TikTok": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/TikTok/TikTok_No_Resolve.yaml",
        "Steam": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Steam/Steam_No_Resolve.yaml",
        "Telegram": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Telegram/Telegram_No_Resolve.yaml",
        "Google": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google_No_Resolve.yaml",
        "Microsoft": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Microsoft/Microsoft_No_Resolve.yaml",
        "PayPal": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/PayPal/PayPal_No_Resolve.yaml",
        "GlobalMedia": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/GlobalMedia/GlobalMedia_Classical_No_Resolve.yaml",
    };
    
    // 3.2 ç”Ÿæˆ Rule Providers é…ç½®å¯¹è±¡
    // è¿™æ®µå¾ªçŽ¯ä¼šæŠŠä¸Šé¢çš„ URL è½¬æ¢æˆ Clash èƒ½è¯»æ‡‚çš„ provider æ ¼å¼
    const generatedProviders = {};
    Object.keys(RULE_CONFIG).forEach(key => {
        if (ruleUrlMap[key]) {
            generatedProviders[key] = {
                type: "http",
                behavior: "classical",
                url: ruleUrlMap[key],
                path: `./ruleset/${key}.yaml`, // è§„åˆ™æ–‡ä»¶ä¸‹è½½åŽå­˜åˆ°æœ¬åœ°è¿™é‡Œ
                interval: 86400, // 24å°æ—¶æ›´æ–°ä¸€æ¬¡è§„åˆ™
                format: "yaml"
            };
        }
    });

    // 3.3 è§„åˆ™é¡ºåº (Clash åŒ¹é…è§„åˆ™æ˜¯ä»Žä¸Šåˆ°ä¸‹çš„ï¼Œå‘½ä¸­å³åœï¼Œæ‰€ä»¥é¡ºåºæžå…¶é‡è¦ï¼)
    // âœ…ã€æ–°å¢žã€‘æœ¬åœ° LAN å…œåº•ï¼šé¿å… LAN è¿œç¨‹ provider æ‹‰å–å¤±è´¥æ—¶ï¼Œå±€åŸŸç½‘æµé‡æŽ‰è¿› MATCH/Proxy
    // âœ…ã€ä¿æŒã€‘ç»Ÿä¸€åœ¨ RULE-SET è¡Œæœ«å°¾åŠ  no-resolve
    // âœ…ã€ä¿®æ”¹ã€‘ChinaMax æ”¹ä¸ºèµ°ç­–ç•¥ç»„ï¼šRULE-SET,ChinaMax,ChinaMax
    const optimizedRules = [
        // ---- æœ¬åœ° LAN å…œåº•ï¼ˆç¡¬è§„åˆ™ï¼Œä¸ä¾èµ–è¿œç¨‹ï¼‰----
        "IP-CIDR,10.0.0.0/8,DIRECT,no-resolve",
        "IP-CIDR,172.16.0.0/12,DIRECT,no-resolve",
        "IP-CIDR,192.168.0.0/16,DIRECT,no-resolve",
        "IP-CIDR,127.0.0.0/8,DIRECT,no-resolve",
        "IP-CIDR,169.254.0.0/16,DIRECT,no-resolve",
        "DOMAIN-SUFFIX,local,DIRECT",
        "DOMAIN-SUFFIX,lan,DIRECT",

        // å…ˆåˆ¤æ–­å±€åŸŸç½‘ï¼Œä¸èµ°æµé‡
        "RULE-SET,LAN,DIRECT,no-resolve",
        // å†åˆ¤æ–­å›½å†…åº”ç”¨ï¼ˆSteamCN, Bç«™ç­‰ï¼‰ï¼Œè®©å®ƒä»¬ç›´è¿ž
        "RULE-SET,SteamCN,SteamCN,no-resolve", 
        "RULE-SET,BiliBili,BiliBili,no-resolve",
        "RULE-SET,Apple,Apple,no-resolve", 

        // ç„¶åŽæ˜¯å¿…é¡»è¦èµ°ä»£ç†çš„å›½å¤–åº”ç”¨
        "RULE-SET,OpenAI,OpenAI,no-resolve",
        "RULE-SET,Netflix,Netflix,no-resolve",
        "RULE-SET,Disney,Disney,no-resolve",
        "RULE-SET,TikTok,TikTok,no-resolve",
        "RULE-SET,Telegram,Telegram,no-resolve",
        "RULE-SET,Google,Google,no-resolve",
        "RULE-SET,Microsoft,Microsoft,no-resolve",
        "RULE-SET,PayPal,PayPal,no-resolve",
        "RULE-SET,Steam,Steam,no-resolve",
        
        "RULE-SET,GlobalMedia,GlobalMedia,no-resolve",
        // âœ… æœ€åŽå…œåº•ï¼šå›½å†…æµé‡èµ° ChinaMax ç­–ç•¥ç»„ï¼ˆé»˜è®¤ DIRECTï¼Œå¯æ‰‹åŠ¨åˆ‡ï¼‰
        "RULE-SET,ChinaMax,ChinaMax,no-resolve",
        // æ¼ç½‘ä¹‹é±¼ï¼šä¸Šé¢éƒ½æ²¡åŒ¹é…åˆ°çš„ï¼Œå…¨éƒ¨èµ° Proxy
        "MATCH," + PROXY_NAME,
    ];

    // 3.4 å®‰å…¨åˆå¹¶ï¼šæŠŠæ–°ç”Ÿæˆçš„ provider å’Œ rules å¡žå›žé…ç½®é‡Œ
    params["rule-providers"] = { 
        ...(params["rule-providers"] || {}), 
        ...generatedProviders 
    };
    params["rules"] = optimizedRules;
}

// ================= 4. è¦†å†™ä»£ç†ç»„ (ä¿®æ­£æ­£åˆ™ & åŠ å…¥ lazy: true) =================
function overwriteProxyGroups(params) {
    // æ‹¿åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„åå­—åˆ—è¡¨
    const allProxies = params["proxies"].map((e) => e.name);

    // 4.1 åœ°åŒºæ­£åˆ™ (é‡ç‚¹ï¼ï¼)
    // è¿™é‡Œå®šä¹‰äº†å¦‚ä½•é€šè¿‡åå­—ç­›é€‰èŠ‚ç‚¹
    const regionFilterRegexs = [
        // ä¿®æ­£ç‰ˆæ­£åˆ™ï¼š
        // 1. åŒ¹é…â€œé¦™æ¸¯â€ã€â€œHong Kongâ€
        // 2. åŒ¹é…â€œHKâ€å¼€å¤´æˆ–ç»“å°¾ï¼Œæˆ–è€…ä¸­é—´å¤¹ç€
        // 3. å…³é”®ç‚¹ï¼š(\d+)? å…è®¸ HK åŽé¢ç›´æŽ¥è·Ÿæ•°å­—ï¼ˆå¦‚ HK01ï¼‰ï¼Œè§£å†³äº†ä¹‹å‰ HK01 ä¸åŒ¹é…çš„é—®é¢˜
        // 4. åŒæ—¶é˜²æ­¢äº† HKG è¿™ç§éžæ•°å­—åŽç¼€è¢«è¯¯ä¼¤
        { name: "ðŸ‡­ðŸ‡° Hong Kong", regex: /é¦™æ¸¯|Hong\s*Kong|ðŸ‡­ðŸ‡°|(^|[\s\-_])HK(\d+)?([\s\-_]|$)/i }, 
        { name: "ðŸ‡¸ðŸ‡¬ Singapore", regex: /æ–°åŠ å¡|ç‹®åŸŽ|SG|Singapore|ðŸ‡¸ðŸ‡¬/i },
        { name: "ðŸ‡¯ðŸ‡µ Japan", regex: /æ—¥æœ¬|JP|Japan|ðŸ‡¯ðŸ‡µ/i },
        { name: "ðŸ‡ºðŸ‡¸ United States", regex: /ç¾Žå›½|US|United States|America|ðŸ‡ºðŸ‡¸/i },
        { name: "ðŸ‡¨ðŸ‡³ Taiwan", regex: /å°æ¹¾|TW|Taiwan|ðŸ‡¹ðŸ‡¼/i }, 
        { name: "ðŸ‡©ðŸ‡ª Germany", regex: /å¾·å›½|DE|Germany|ðŸ‡©ðŸ‡ª/i },
        { name: "ðŸ‡¬ðŸ‡§ United Kingdom", regex: /è‹±å›½|UK|United Kingdom|Britain|ðŸ‡¬ðŸ‡§/i },
        { name: "ðŸ‡°ðŸ‡· South Korea", regex: /éŸ©å›½|KR|South Korea|ðŸ‡°ðŸ‡·/i },
    ];

    // 4.2 ç”Ÿæˆåœ°åŒºæµ‹é€Ÿç»„
    const regionProxyGroups = regionFilterRegexs
        .map((item) => {
            // ç”¨æ­£åˆ™æŠŠèŠ‚ç‚¹æŒ‘å‡ºæ¥
            const proxies = getProxiesByRegex(params, item.regex);
            return {
                name: item.name,
                type: "url-test", // è‡ªåŠ¨æµ‹é€Ÿï¼Œé€‰å»¶è¿Ÿæœ€ä½Žçš„
                url: TEST_URL,
                interval: TEST_INTERVAL,
                tolerance: TEST_TOLERANCE,
                proxies,
                lazy: true, // ã€æ€§èƒ½ä¼˜åŒ–ç‚¹ã€‘åªæœ‰å½“è¿™ä¸ªç»„è¢«ä½¿ç”¨æ—¶æ‰æµ‹é€Ÿï¼Œå¹³æ—¶ä¼‘çœ ï¼Œçœç”µçœæµé‡
            };
        })
        .filter((item) => item.proxies.length > 0); // å¦‚æžœæŸä¸ªåœ°åŒºæ²¡èŠ‚ç‚¹ï¼Œå°±ä¸ç”Ÿæˆè¿™ä¸ªç»„

    const regionGroupNames = regionProxyGroups.map((g) => g.name);

    // 4.3 ç”Ÿæˆè§„åˆ™é›†ç­–ç•¥ç»„ (å¯¹åº” Section 0 çš„é…ç½®)
    // æ¯”å¦‚ç”Ÿæˆä¸€ä¸ªå« "Netflix" çš„ç»„ï¼Œè®©ä½ å¯ä»¥æ‰‹åŠ¨é€‰æ˜¯èµ° "Proxy" è¿˜æ˜¯ "é¦™æ¸¯"
    // âœ…ã€ä¿®æ”¹ã€‘LAN ç»„åªä¿ç•™ DIRECT ä¸€ä¸ªé€‰é¡¹ï¼ˆåªè¯»æŒ‡ç¤ºç¯ï¼‰
    const ruleSetProxyGroups = Object.keys(RULE_CONFIG).map((ruleSetName) => {
        const defaultStrategy = RULE_CONFIG[ruleSetName];
        let proxies;

        if (ruleSetName === "LAN") {
            proxies = ["DIRECT"];
        } else if (defaultStrategy === "DIRECT") {
            // å¦‚æžœé»˜è®¤æ˜¯ DIRECTï¼Œå°±æŠŠ DIRECT æ”¾åœ¨ç¬¬ä¸€ä¸ªï¼ˆé»˜è®¤é€‰ä¸­ï¼‰
            proxies = ["DIRECT", PROXY_NAME, ...regionGroupNames];
        } else {
            // å¦åˆ™é»˜è®¤é€‰ä¸­ Proxy
            proxies = [PROXY_NAME, ...regionGroupNames, "DIRECT"];
        }

        return {
            name: ruleSetName,
            type: "select", // æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼
            proxies,
        };
    });

    // 4.4 å…¨å±€è‡ªåŠ¨æµ‹é€Ÿç»„ (æ‰€æœ‰èŠ‚ç‚¹å¤§ä¹±æ–—)
    const autoSelect = {
        name: "ðŸŒ Auto",
        type: "url-test",
        url: TEST_URL,
        interval: TEST_INTERVAL,
        tolerance: TEST_TOLERANCE,
        proxies: [...allProxies],
        lazy: true, // åŒæ ·å¼€å¯ lazyï¼Œé˜²æ­¢åŽå°ç–¯ç‹‚æµ‹é€Ÿ
    };

    // ä¸»ä»£ç†ç»„ï¼šåŒ…æ‹¬è‡ªåŠ¨é€‰æ‹©ã€å„ä¸ªåœ°åŒºç»„ã€æ‰€æœ‰èŠ‚ç‚¹
    const proxyGroup = {
        name: PROXY_NAME,
        type: "select",
        proxies: ["ðŸŒ Auto", ...regionGroupNames, ...allProxies, "DIRECT"],
    };

    // 4.5 å†™å…¥é…ç½®
    params["proxy-groups"] = [
        proxyGroup,
        autoSelect,
        ...ruleSetProxyGroups,
        ...regionProxyGroups
    ];
}

// ================= 5. è¦†å†™ DNS (æœ€ç»ˆå®‰å…¨ç‰ˆ - é˜²æ­¢ DNS æ³„éœ²) =================
function overwriteDns(params) {
    // å›½å†… DNSï¼šé˜¿é‡Œå’Œè…¾è®¯ï¼Œè§£æžå›½å†…å¿«
    const cnDnsList = [
        "223.5.5.5", "223.6.6.6", 
        "119.29.29.29", "119.28.28.28",
    ];
    // å›½å¤– DNSï¼šDoH (DNS over HTTPS)ï¼ŒåŠ å¯†æŸ¥è¯¢ï¼Œé˜²æ­¢æ±¡æŸ“
    const trustDnsList = [
        "https://cloudflare-dns.com/dns-query",
        "https://dns.google/dns-query",
        "https://1.1.1.1/dns-query",
        "https://8.8.4.4/dns-query",
    ];

    const dnsOptions = {
        "enable": true,
        "ipv6": false, // ç›®å‰ IPv6 åœ¨ä»£ç†çŽ¯å¢ƒä¸‹å‘å¤šï¼Œå…³æŽ‰ä¿å¹³å®‰
        "prefer-h3": true,
        
        // Fake-IP æ¨¡å¼ï¼šè¿”å›žå‡ IP ç»™è½¯ä»¶ï¼Œå®žçŽ°ç§’è¿žï¼ŒåŽç»­ç”± Clash è¿œç¨‹è§£æžåŸŸå
        "enhanced-mode": "fake-ip", 
        "fake-ip-range": "198.18.0.1/16",
        
        // ç”šè‡³ä¸ç»™è¿™äº›åŸŸåè¿”å›ž Fake-IPï¼Œå¼ºåˆ¶å®ƒä»¬ç”¨çœŸ IP (é€šå¸¸æ˜¯ä¸ºäº†å…¼å®¹æ€§)
        "fake-ip-filter": [
            "*.lan",
            "*.local",
            "localhost",
            "localhost.*",
            "router.asus.com", 
            "dns.msftncsi.com",
            "www.msftconnecttest.com",
            "time.*",
            "ntp.*",
            "id.qq.com", 
        ],

        // é»˜è®¤ DNS (Fallback ç”¨ï¼Œæˆ–è€…éžç­–ç•¥åŒ¹é…æ—¶ç”¨)
        "default-nameserver": ["223.5.5.5", "119.29.29.29"], 
        "nameserver": trustDnsList, 

        // âœ… ä¸“é—¨ç»™ä»£ç†æœåŠ¡å™¨åŸŸåè§£æžç”¨ï¼Œå¢žå¼ºç¨³å®šæ€§/é˜²æ³„éœ²
        "proxy-server-nameserver": cnDnsList,
        // âœ… è®© DNS è¡Œä¸ºæ›´è´´è¿‘åˆ†æµè§„åˆ™
        "respect-rules": true,

        // ã€æ ¸å¿ƒé«˜çº§åŠŸèƒ½ã€‘Nameserver Policy
        "nameserver-policy": {
            "geosite:cn": cnDnsList,
            "geosite:geolocation-!cn": trustDnsList,
        },
    };

    // GEO èµ„æºåŠ é€Ÿï¼šæŠŠ geoip/geosite æ•°æ®åº“æ¢æˆå›½å†… GitHub é•œåƒåœ°å€ï¼Œä¸‹è½½æ›´å¿«
    const rawGeoxURLs = {
        "geoip": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat",
        "geosite": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat",
        "mmdb": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb",
    };
    const githubPrefix = "https://fastgh.lainbo.com/"; // åŠ é€Ÿå‰ç¼€
    const accelURLs = Object.fromEntries(
        Object.entries(rawGeoxURLs).map(([key, githubUrl]) => [
            key, `${githubPrefix}${githubUrl}`,
        ])
    );

    const otherOptions = {
        "unified-delay": true, // ç»Ÿä¸€å»¶è¿Ÿè®¡ç®—
        "tcp-concurrent": true, // TCP å¹¶å‘ï¼Œå¿«ä¸€ç‚¹æ˜¯ä¸€ç‚¹
        "profile": { "store-selected": true, "store-fake-ip": true }, // è®°ä½ä½ ä¸Šæ¬¡é€‰çš„èŠ‚ç‚¹
        "sniffer": { "enable": true, "sniff": { "TLS": { "ports": [443, 8443] }, "HTTP": { "ports": [80, "8080-8880"], "override-destination": true } } },
        "geodata-mode": true, // å¼€å¯æ–°ç‰ˆ geodata æ¨¡å¼
        "geox-url": accelURLs, // åº”ç”¨åŠ é€Ÿåœ°å€
    };

    params.dns = { ...params.dns, ...dnsOptions };
    Object.keys(otherOptions).forEach((key) => { params[key] = otherOptions[key]; });
}

// ================= è¾…åŠ©å‡½æ•° =================
function getProxiesByRegex(params, regex) {
    // ç®€å•çš„è¿‡æ»¤å™¨ï¼šç»™æˆ‘é…ç½®é‡Œçš„æ‰€æœ‰èŠ‚ç‚¹ -> åªè¦åå­—ç¬¦åˆæ­£åˆ™çš„ -> è¿”å›žåå­—åˆ—è¡¨
    return params.proxies
        .filter((e) => e.name.match(regex))
        .map((e) => e.name);
}
