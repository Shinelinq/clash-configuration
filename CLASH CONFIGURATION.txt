// ================= 0. å…¨å±€å¸¸é‡å®šä¹‰ (è¿™æ˜¯ä½ çš„â€œæˆ˜æœ¯æŒ‡æŒ¥ä¸­å¿ƒâ€) =================

// ä»£ç†æ€»å‡ºå£åç§°ï¼šæ‰€æœ‰çš„è§„åˆ™æ²¡åŒ¹é…åˆ°çš„ï¼Œæˆ–è€…é€‰äº† PROXY çš„ï¼Œæœ€åŽéƒ½æµå‘è¿™é‡Œ
const PROXY_NAME = "Proxy";

// æµ‹é€Ÿè®¾ç½®ï¼šè¿™æ˜¯ç»™èŠ‚ç‚¹â€œä½“æ£€â€çš„æ ‡å‡†
const TEST_URL = "https://cp.cloudflare.com/generate_204"; // ç»å…¸çš„ CF æµ‹é€Ÿåœ°å€ï¼Œè½»é‡
const TEST_INTERVAL = 300; // æ¯ 300 ç§’ï¼ˆ5åˆ†é’Ÿï¼‰æµ‹ä¸€æ¬¡ï¼Œä¸è‡³äºŽæŠŠæœºåœºè·‘å´©
const TEST_TOLERANCE = 50; // å®¹å·® 50msï¼Œé˜²æ­¢èŠ‚ç‚¹å› ä¸ºå¾®å°æ³¢åŠ¨é¢‘ç¹åˆ‡æ¢

// è§„åˆ™é›†é…ç½®æ¸…å•ï¼šè¿™æ˜¯ä½ çš„â€œçº¢ç»¿ç¯â€ç­–ç•¥è¡¨
// å·¦è¾¹æ˜¯ç­–ç•¥ç»„åå­—ï¼Œå³è¾¹æ˜¯é»˜è®¤ç­–ç•¥ (DIRECT=ç›´è¿ž, PROXY=èµ°ä»£ç†)
const RULE_CONFIG = {
Â  Â  // --- é»˜è®¤ç›´è¿žç»„ (å›½å†…æœåŠ¡ï¼Œä¸æµªè´¹æµé‡) ---
Â  Â  "LAN": "DIRECT", Â  Â  Â  Â // å±€åŸŸç½‘
Â  Â  "ChinaMax": "DIRECT", Â  // ä¹Ÿå°±æ˜¯ GeoSite CNï¼ŒåŒ…å«å‡ ä¹Žæ‰€æœ‰å›½å†…åŸŸå
Â  Â  "SteamCN": "DIRECT", Â  Â // Steam å•†åº—é¡µé¢ç­‰å›½å†…éƒ¨åˆ†
Â  Â  "BiliBili": "DIRECT", Â  // Bç«™ç›´è¿žï¼ˆé™¤éžä½ è¦çœ‹æ¸¯æ¾³å°é™å®šï¼‰
Â  Â  "Apple": "DIRECT", Â  Â  Â // è‹¹æžœæœåŠ¡ï¼Œå›½å†…é€šå¸¸ç›´è¿žæ›´å¿«
Â  Â  
Â  Â  // --- é»˜è®¤ä»£ç†ç»„ (å›½å¤–æœåŠ¡ï¼Œå¿…é¡»ç¿»å¢™) ---
Â  Â  "OpenAI": "PROXY", Â  Â  Â // ChatGPT
Â  Â  "Netflix": "PROXY", Â  Â  // å¥¶é£ž
Â  Â  "Disney": "PROXY", Â  Â  Â // è¿ªå£«å°¼+
Â  Â  "TikTok": "PROXY", Â  Â  Â // å›½é™…ç‰ˆæŠ–éŸ³
Â  Â  "Steam": "PROXY", Â  Â  Â  // Steam ç¤¾åŒº/è”æœºéƒ¨åˆ†
Â  Â  "Telegram": "PROXY", Â  Â // ç”µæŠ¥
Â  Â  "Google": "PROXY", Â  Â  Â // è°·æ­Œå…¨å®¶æ¡¶
Â  Â  "Microsoft": "PROXY", Â  // å¾®è½¯ (æœ‰æ—¶éœ€è¦ä»£ç†åŠ é€Ÿ)
Â  Â  "PayPal": "PROXY", Â  Â  Â // æ”¯ä»˜
Â  Â  "GlobalMedia": "PROXY" Â // å…¶ä»–å›½å¤–æµåª’ä½“
};

// ================= 1. ä¸»å‡½æ•°å…¥å£ (è¿™æ˜¯è„šæœ¬çš„å¤§è„‘) =================
// Clash Verge å¯åŠ¨æ—¶ä¼šæŠŠé»˜è®¤é…ç½®å¡žç»™ configï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£æŠŠ config æ”¹é€ æˆä½ è¦çš„æ ·å­
function main(config) {
Â  Â  // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æžœè¿žèŠ‚ç‚¹éƒ½æ²¡æœ‰ï¼Œè¿˜æŠ˜è…¾å•¥ï¼Ÿç›´æŽ¥åŽŸè·¯è¿”å›ž
Â  Â  if (!config.proxies || config.proxies.length === 0)
Â  Â  Â  Â  return config;

Â  Â  // æŽ¥ä¸‹æ¥åƒæµæ°´çº¿ä¸€æ ·åŠ å·¥é…ç½®ï¼Œé¡ºåºå¾ˆé‡è¦ï¼
Â  Â  overwriteRules(config); Â  Â  Â  // 3. æžå®šåˆ†æµè§„åˆ™ (å“ªäº›åŸŸåèµ°å“ªæ¡è·¯)
Â  Â  overwriteProxyGroups(config); // 4. æžå®šç­–ç•¥ç»„ (æŠŠèŠ‚ç‚¹åˆ†ç»„ï¼Œæ¯”å¦‚é¦™æ¸¯ç»„ã€ç¾Žå›½ç»„)
Â  Â  overwriteDns(config); Â  Â  Â  Â  // 5. æžå®š DNS (é˜²æ­¢ DNS æ±¡æŸ“ï¼Œæ ¸å¿ƒä¸­çš„æ ¸å¿ƒ)
Â  Â  addCustomRules(config); Â  Â  Â  // 2. æ’å…¥ä½ çš„ç§è´§ (æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™)

Â  Â  return config; // æŠŠæ”¹å¥½çš„é…ç½®äº¤è¿˜ç»™å†…æ ¸
}

// ================= 2. è‡ªå®šä¹‰è§„åˆ™ (è¿™æ˜¯ VIP å¿«é€Ÿé€šé“) =================
function addCustomRules(config) {
Â  Â  const customRules = [
Â  Â  Â  Â  // ç¤ºä¾‹ï¼šåœ¨è¿™é‡Œå†™çš„è§„åˆ™ä¼šæ’åœ¨æœ€å‰é¢ï¼Œä¼˜å…ˆçº§æœ€é«˜
Â  Â  Â  Â  // å¦‚æžœä½ æƒ³å¼ºåˆ¶ notion èµ°ç¾Žå›½ï¼Œå°±åœ¨è¿™å†™
Â  Â  Â  Â  // "RULE-SET,Google,ðŸ‡ºðŸ‡¸ United States",
Â  Â  ];
Â  Â  // æŠŠä½ çš„ç§è´§æ”¾åˆ°åŽŸæœ‰è§„åˆ™åˆ—è¡¨çš„å¤´éƒ¨
Â  Â  config["rules"] = [...customRules, ...config["rules"]];
}

// ================= 3. è¦†å†™è§„åˆ™ & Providers (è¿™æ˜¯ä½ çš„â€œå¤–åŒ…å›¢é˜Ÿâ€) =================
function overwriteRules(params) {
Â  Â  // 3.1 è§„åˆ™é›† URL æ˜ å°„è¡¨ï¼šè¿™é‡Œå¼•ç”¨äº† blackmatrix7 å¤§ä½¬ç»´æŠ¤çš„è§„åˆ™æ–‡ä»¶
Â  Â  // å®ƒä»¬åŒ…å«äº†æˆåƒä¸Šä¸‡æ¡åŸŸåï¼Œä¸ç”¨ä½ è‡ªå·±æ‰‹å†™
Â  Â  const ruleUrlMap = {
Â  Â  Â  Â  "LAN": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan_No_Resolve.yaml",
Â  Â  Â  Â  "ChinaMax": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaMax/ChinaMax_Classical_No_IPv6_No_Resolve.yaml",
Â  Â  Â  Â  "SteamCN": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN_No_Resolve.yaml",
Â  Â  Â  Â  "BiliBili": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/BiliBili/BiliBili_No_Resolve.yaml",
Â  Â  Â  Â  "Apple": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Apple/Apple_Classical_No_Resolve.yaml",
Â  Â  Â  Â  "OpenAI": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI_No_Resolve.yaml",
Â  Â  Â  Â  "Netflix": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Netflix/Netflix_No_Resolve.yaml",
Â  Â  Â  Â  "Disney": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Disney/Disney_No_Resolve.yaml",
Â  Â  Â  Â  "TikTok": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/TikTok/TikTok_No_Resolve.yaml",
Â  Â  Â  Â  "Steam": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Steam/Steam_No_Resolve.yaml",
Â  Â  Â  Â  "Telegram": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Telegram/Telegram_No_Resolve.yaml",
Â  Â  Â  Â  "Google": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google_No_Resolve.yaml",
Â  Â  Â  Â  "Microsoft": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Microsoft/Microsoft_No_Resolve.yaml",
Â  Â  Â  Â  "PayPal": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/PayPal/PayPal_No_Resolve.yaml",
Â  Â  Â  Â  "GlobalMedia": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/GlobalMedia/GlobalMedia_Classical_No_Resolve.yaml",
Â  Â  };
Â  Â  
Â  Â  // 3.2 ç”Ÿæˆ Rule Providers é…ç½®å¯¹è±¡
Â  Â  // è¿™æ®µå¾ªçŽ¯ä¼šæŠŠä¸Šé¢çš„ URL è½¬æ¢æˆ Clash èƒ½è¯»æ‡‚çš„ provider æ ¼å¼
Â  Â  const generatedProviders = {};
Â  Â  Object.keys(RULE_CONFIG).forEach(key => {
Â  Â  Â  Â  if (ruleUrlMap[key]) {
Â  Â  Â  Â  Â  Â  generatedProviders[key] = {
Â  Â  Â  Â  Â  Â  Â  Â  type: "http",
Â  Â  Â  Â  Â  Â  Â  Â  behavior: "classical",
Â  Â  Â  Â  Â  Â  Â  Â  url: ruleUrlMap[key],
Â  Â  Â  Â  Â  Â  Â  Â  path: `./ruleset/${key}.yaml`, // è§„åˆ™æ–‡ä»¶ä¸‹è½½åŽå­˜åˆ°æœ¬åœ°è¿™é‡Œ
Â  Â  Â  Â  Â  Â  Â  Â  interval: 86400, // 24å°æ—¶æ›´æ–°ä¸€æ¬¡è§„åˆ™
Â  Â  Â  Â  Â  Â  Â  Â  format: "yaml"
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // 3.3 è§„åˆ™é¡ºåº (Clash åŒ¹é…è§„åˆ™æ˜¯ä»Žä¸Šåˆ°ä¸‹çš„ï¼Œå‘½ä¸­å³åœï¼Œæ‰€ä»¥é¡ºåºæžå…¶é‡è¦ï¼)
Â  Â  const optimizedRules = [
Â  Â  Â  Â  // å…ˆåˆ¤æ–­å±€åŸŸç½‘ï¼Œä¸èµ°æµé‡
Â  Â  Â  Â  "RULE-SET,LAN,DIRECT",
Â  Â  Â  Â  // å†åˆ¤æ–­å›½å†…åº”ç”¨ï¼ˆSteamCN, Bç«™ç­‰ï¼‰ï¼Œè®©å®ƒä»¬ç›´è¿ž
Â  Â  Â  Â  "RULE-SET,SteamCN,SteamCN", 
Â  Â  Â  Â  "RULE-SET,BiliBili,BiliBili",
Â  Â  Â  Â  "RULE-SET,Apple,Apple", 

Â  Â  Â  Â  // ç„¶åŽæ˜¯å¿…é¡»è¦èµ°ä»£ç†çš„å›½å¤–åº”ç”¨
Â  Â  Â  Â  "RULE-SET,OpenAI,OpenAI",
Â  Â  Â  Â  "RULE-SET,Netflix,Netflix",
Â  Â  Â  Â  "RULE-SET,Disney,Disney",
Â  Â  Â  Â  "RULE-SET,TikTok,TikTok",
Â  Â  Â  Â  "RULE-SET,Telegram,Telegram",
Â  Â  Â  Â  "RULE-SET,Google,Google",
Â  Â  Â  Â  "RULE-SET,Microsoft,Microsoft",
Â  Â  Â  Â  "RULE-SET,PayPal,PayPal",
Â  Â  Â  Â  "RULE-SET,Steam,Steam",
Â  Â  Â  Â  
Â  Â  Â  Â  "RULE-SET,GlobalMedia,GlobalMedia",
Â  Â  Â  Â  // æœ€åŽå…œåº•ï¼šå›½å†…æµé‡èµ°ç›´è¿ž
Â  Â  Â  Â  "RULE-SET,ChinaMax,DIRECT", 
Â  Â  Â  Â  // æ¼ç½‘ä¹‹é±¼ï¼šä¸Šé¢éƒ½æ²¡åŒ¹é…åˆ°çš„ï¼Œå…¨éƒ¨èµ° Proxy
Â  Â  Â  Â  "MATCH," + PROXY_NAME,
Â  Â  ];

Â  Â  // 3.4 å®‰å…¨åˆå¹¶ï¼šæŠŠæ–°ç”Ÿæˆçš„ provider å’Œ rules å¡žå›žé…ç½®é‡Œ
Â  Â  params["rule-providers"] = { 
Â  Â  Â  Â  ...(params["rule-providers"] || {}), 
Â  Â  Â  Â  ...generatedProviders 
Â  Â  };
Â  Â  params["rules"] = optimizedRules;
}

// ================= 4. è¦†å†™ä»£ç†ç»„ (ä¿®æ­£æ­£åˆ™ & åŠ å…¥ lazy: true) =================
function overwriteProxyGroups(params) {
Â  Â  // æ‹¿åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„åå­—åˆ—è¡¨
Â  Â  const allProxies = params["proxies"].map((e) => e.name);

Â  Â  // 4.1 åœ°åŒºæ­£åˆ™ (é‡ç‚¹ï¼ï¼)
Â  Â  // è¿™é‡Œå®šä¹‰äº†å¦‚ä½•é€šè¿‡åå­—ç­›é€‰èŠ‚ç‚¹
Â  Â  const regionFilterRegexs = [
Â  Â  Â  Â  // ä¿®æ­£ç‰ˆæ­£åˆ™ï¼š
Â  Â  Â  Â  // 1. åŒ¹é…â€œé¦™æ¸¯â€ã€â€œHong Kongâ€
Â  Â  Â  Â  // 2. åŒ¹é…â€œHKâ€å¼€å¤´æˆ–ç»“å°¾ï¼Œæˆ–è€…ä¸­é—´å¤¹ç€
Â  Â  Â  Â  // 3. å…³é”®ç‚¹ï¼š(\d+)? å…è®¸ HK åŽé¢ç›´æŽ¥è·Ÿæ•°å­—ï¼ˆå¦‚ HK01ï¼‰ï¼Œè§£å†³äº†ä¹‹å‰ HK01 ä¸åŒ¹é…çš„é—®é¢˜
Â  Â  Â  Â  // 4. åŒæ—¶é˜²æ­¢äº† HKG è¿™ç§éžæ•°å­—åŽç¼€è¢«è¯¯ä¼¤
Â  Â  Â  Â  { name: "ðŸ‡­ðŸ‡° Hong Kong", regex: /é¦™æ¸¯|Hong\s*Kong|ðŸ‡­ðŸ‡°|(^|[\s\-_])HK(\d+)?([\s\-_]|$)/i }, 
Â  Â  Â  Â  { name: "ðŸ‡¸ðŸ‡¬ Singapore", regex: /æ–°åŠ å¡|ç‹®åŸŽ|SG|Singapore|ðŸ‡¸ðŸ‡¬/i },
Â  Â  Â  Â  { name: "ðŸ‡¯ðŸ‡µ Japan", regex: /æ—¥æœ¬|JP|Japan|ðŸ‡¯ðŸ‡µ/i },
Â  Â  Â  Â  { name: "ðŸ‡ºðŸ‡¸ United States", regex: /ç¾Žå›½|US|United States|America|ðŸ‡ºðŸ‡¸/i },
Â  Â  Â  Â  { name: "ðŸ‡¨ðŸ‡³ Taiwan", regex: /å°æ¹¾|TW|Taiwan|ðŸ‡¹ðŸ‡¼/i }, 
Â  Â  Â  Â  { name: "ðŸ‡©ðŸ‡ª Germany", regex: /å¾·å›½|DE|Germany|ðŸ‡©ðŸ‡ª/i },
Â  Â  Â  Â  { name: "ðŸ‡¬ðŸ‡§ United Kingdom", regex: /è‹±å›½|UK|United Kingdom|Britain|ðŸ‡¬ðŸ‡§/i },
Â  Â  Â  Â  { name: "ðŸ‡°ðŸ‡· South Korea", regex: /éŸ©å›½|KR|South Korea|ðŸ‡°ðŸ‡·/i },
Â  Â  ];

Â  Â  // 4.2 ç”Ÿæˆåœ°åŒºæµ‹é€Ÿç»„
Â  Â  const regionProxyGroups = regionFilterRegexs
Â  Â  Â  Â  .map((item) => {
Â  Â  Â  Â  Â  Â  // ç”¨æ­£åˆ™æŠŠèŠ‚ç‚¹æŒ‘å‡ºæ¥
Â  Â  Â  Â  Â  Â  const proxies = getProxiesByRegex(params, item.regex);
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  name: item.name,
Â  Â  Â  Â  Â  Â  Â  Â  type: "url-test", // è‡ªåŠ¨æµ‹é€Ÿï¼Œé€‰å»¶è¿Ÿæœ€ä½Žçš„
Â  Â  Â  Â  Â  Â  Â  Â  url: TEST_URL,
Â  Â  Â  Â  Â  Â  Â  Â  interval: TEST_INTERVAL,
Â  Â  Â  Â  Â  Â  Â  Â  tolerance: TEST_TOLERANCE,
Â  Â  Â  Â  Â  Â  Â  Â  proxies,
Â  Â  Â  Â  Â  Â  Â  Â  lazy: true, // ã€æ€§èƒ½ä¼˜åŒ–ç‚¹ã€‘åªæœ‰å½“è¿™ä¸ªç»„è¢«ä½¿ç”¨æ—¶æ‰æµ‹é€Ÿï¼Œå¹³æ—¶ä¼‘çœ ï¼Œçœç”µçœæµé‡
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  })
Â  Â  Â  Â  .filter((item) => item.proxies.length > 0); // å¦‚æžœæŸä¸ªåœ°åŒºæ²¡èŠ‚ç‚¹ï¼Œå°±ä¸ç”Ÿæˆè¿™ä¸ªç»„

Â  Â  const regionGroupNames = regionProxyGroups.map((g) => g.name);

Â  Â  // 4.3 ç”Ÿæˆè§„åˆ™é›†ç­–ç•¥ç»„ (å¯¹åº” Section 0 çš„é…ç½®)
Â  Â  // æ¯”å¦‚ç”Ÿæˆä¸€ä¸ªå« "Netflix" çš„ç»„ï¼Œè®©ä½ å¯ä»¥æ‰‹åŠ¨é€‰æ˜¯èµ° "Proxy" è¿˜æ˜¯ "é¦™æ¸¯"
Â  Â  const ruleSetProxyGroups = Object.keys(RULE_CONFIG).map((ruleSetName) => {
Â  Â  Â  Â  const defaultStrategy = RULE_CONFIG[ruleSetName];
Â  Â  Â  Â  let proxies;

Â  Â  Â  Â  // å¦‚æžœé»˜è®¤æ˜¯ DIRECTï¼Œå°±æŠŠ DIRECT æ”¾åœ¨ç¬¬ä¸€ä¸ªï¼ˆé»˜è®¤é€‰ä¸­ï¼‰
Â  Â  Â  Â  if (defaultStrategy === "DIRECT") {
Â  Â  Â  Â  Â  Â  proxies = ["DIRECT", PROXY_NAME, ...regionGroupNames];
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // å¦åˆ™é»˜è®¤é€‰ä¸­ Proxy
Â  Â  Â  Â  Â  Â  proxies = [PROXY_NAME, ...regionGroupNames, "DIRECT"];
Â  Â  Â  Â  }

Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  name: ruleSetName,
Â  Â  Â  Â  Â  Â  type: "select", // æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼
Â  Â  Â  Â  Â  Â  proxies,
Â  Â  Â  Â  };
Â  Â  });

Â  Â  // 4.4 å…¨å±€è‡ªåŠ¨æµ‹é€Ÿç»„ (æ‰€æœ‰èŠ‚ç‚¹å¤§ä¹±æ–—)
Â  Â  const autoSelect = {
Â  Â  Â  Â  name: "ðŸŒ Auto",
Â  Â  Â  Â  type: "url-test",
Â  Â  Â  Â  url: TEST_URL,
Â  Â  Â  Â  interval: TEST_INTERVAL,
Â  Â  Â  Â  tolerance: TEST_TOLERANCE,
Â  Â  Â  Â  proxies: [...allProxies],
Â  Â  Â  Â  lazy: true, // åŒæ ·å¼€å¯ lazyï¼Œé˜²æ­¢åŽå°ç–¯ç‹‚æµ‹é€Ÿ
Â  Â  };

Â  Â  // ä¸»ä»£ç†ç»„ï¼šåŒ…æ‹¬è‡ªåŠ¨é€‰æ‹©ã€å„ä¸ªåœ°åŒºç»„ã€æ‰€æœ‰èŠ‚ç‚¹
Â  Â  const proxyGroup = {
Â  Â  Â  Â  name: PROXY_NAME,
Â  Â  Â  Â  type: "select",
Â  Â  Â  Â  proxies: ["ðŸŒ Auto", ...regionGroupNames, ...allProxies, "DIRECT"],
Â  Â  };

Â  Â  // 4.5 å†™å…¥é…ç½®
Â  Â  params["proxy-groups"] = [
Â  Â  Â  Â  proxyGroup,
Â  Â  Â  Â  autoSelect,
Â  Â  Â  Â  ...ruleSetProxyGroups,
Â  Â  Â  Â  ...regionProxyGroups
Â  Â  ];
}

// ================= 5. è¦†å†™ DNS (æœ€ç»ˆå®‰å…¨ç‰ˆ - é˜²æ­¢ DNS æ³„éœ²) =================
function overwriteDns(params) {
Â  Â  // å›½å†… DNSï¼šé˜¿é‡Œå’Œè…¾è®¯ï¼Œè§£æžå›½å†…å¿«
Â  Â  const cnDnsList = [
Â  Â  Â  Â  "223.5.5.5", "223.6.6.6", 
Â  Â  Â  Â  "119.29.29.29", "119.28.28.28",
Â  Â  ];
Â  Â  // å›½å¤– DNSï¼šDoH (DNS over HTTPS)ï¼ŒåŠ å¯†æŸ¥è¯¢ï¼Œé˜²æ­¢æ±¡æŸ“
Â  Â  const trustDnsList = [
Â  Â  Â  Â  "https://cloudflare-dns.com/dns-query",
Â  Â  Â  Â  "https://dns.google/dns-query",
Â  Â  Â  Â  "https://1.1.1.1/dns-query",
Â  Â  Â  Â  "https://8.8.4.4/dns-query",
Â  Â  ];

Â  Â  const dnsOptions = {
Â  Â  Â  Â  "enable": true,
Â  Â  Â  Â  "ipv6": false, // ç›®å‰ IPv6 åœ¨ä»£ç†çŽ¯å¢ƒä¸‹å‘å¤šï¼Œå…³æŽ‰ä¿å¹³å®‰
Â  Â  Â  Â  "prefer-h3": true,
Â  Â  Â  Â  
Â  Â  Â  Â  // Fake-IP æ¨¡å¼ï¼šè¿”å›žå‡ IP ç»™è½¯ä»¶ï¼Œå®žçŽ°ç§’è¿žï¼ŒåŽç»­ç”± Clash è¿œç¨‹è§£æžåŸŸå
Â  Â  Â  Â  "enhanced-mode": "fake-ip", 
Â  Â  Â  Â  "fake-ip-range": "198.18.0.1/16",
Â  Â  Â  Â  
Â  Â  Â  Â  // ç”šè‡³ä¸ç»™è¿™äº›åŸŸåè¿”å›ž Fake-IPï¼Œå¼ºåˆ¶å®ƒä»¬ç”¨çœŸ IP (é€šå¸¸æ˜¯ä¸ºäº†å…¼å®¹æ€§)
Â  Â  Â  Â  "fake-ip-filter": [
Â  Â  Â  Â  Â  Â  "*.lan",
Â  Â  Â  Â  Â  Â  "*.local",
Â  Â  Â  Â  Â  Â  "localhost",
Â  Â  Â  Â  Â  Â  "localhost.*",
Â  Â  Â  Â  Â  Â  "router.asus.com", 
Â  Â  Â  Â  Â  Â  "dns.msftncsi.com",
Â  Â  Â  Â  Â  Â  "www.msftconnecttest.com",
Â  Â  Â  Â  Â  Â  "time.*",
Â  Â  Â  Â  Â  Â  "ntp.*",
Â  Â  Â  Â  Â  Â  "id.qq.com", 
Â  Â  Â  Â  ],

Â  Â  Â  Â  // é»˜è®¤ DNS (Fallback ç”¨ï¼Œæˆ–è€…éžç­–ç•¥åŒ¹é…æ—¶ç”¨)
Â  Â  Â  Â  "default-nameserver": ["223.5.5.5", "119.29.29.29"], 
Â  Â  Â  Â  "nameserver": trustDnsList, 
Â  Â  Â  Â  
Â  Â  Â  Â  // ã€æ ¸å¿ƒé«˜çº§åŠŸèƒ½ã€‘Nameserver Policy
Â  Â  Â  Â  // è¿™é‡Œå°±æ˜¯æ¯” fallback-filter é«˜çº§çš„åœ°æ–¹
Â  Â  Â  Â  // æ˜Žç¡®æŒ‡å®šï¼šgeosite æ˜¯ cn çš„åŸŸåï¼Œå¿…é¡»ç”¨å›½å†… DNS è§£æž
Â  Â  Â  Â  // geosite ä¸æ˜¯ cn çš„ï¼Œå¿…é¡»ç”¨å›½å¤– TrustDNS è§£æž
Â  Â  Â  Â  // è¿™æ ·å½»åº•æœç»äº† DNS æ±¡æŸ“ï¼Œä¹Ÿä¸ç”¨å¹¶å‘è¯·æ±‚åŽ»çŒœ
Â  Â  Â  Â  "nameserver-policy": {
Â  Â  Â  Â  Â  Â  "geosite:cn": cnDnsList,
Â  Â  Â  Â  Â  Â  "geosite:geolocation-!cn": trustDnsList,
Â  Â  Â  Â  },
Â  Â  };

Â  Â  // GEO èµ„æºåŠ é€Ÿï¼šæŠŠ geoip/geosite æ•°æ®åº“æ¢æˆå›½å†… GitHub é•œåƒåœ°å€ï¼Œä¸‹è½½æ›´å¿«
Â  Â  const rawGeoxURLs = {
Â  Â  Â  Â  "geoip": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat",
Â  Â  Â  Â  "geosite": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat",
Â  Â  Â  Â  "mmdb": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb",
Â  Â  };
Â  Â  const githubPrefix = "https://fastgh.lainbo.com/"; // åŠ é€Ÿå‰ç¼€
Â  Â  const accelURLs = Object.fromEntries(
Â  Â  Â  Â  Object.entries(rawGeoxURLs).map(([key, githubUrl]) => [
Â  Â  Â  Â  Â  Â  key, `${githubPrefix}${githubUrl}`,
Â  Â  Â  Â  ])
Â  Â  );

Â  Â  const otherOptions = {
Â  Â  Â  Â  "unified-delay": true, // ç»Ÿä¸€å»¶è¿Ÿè®¡ç®—
Â  Â  Â  Â  "tcp-concurrent": true, // TCP å¹¶å‘ï¼Œå¿«ä¸€ç‚¹æ˜¯ä¸€ç‚¹
Â  Â  Â  Â  "profile": { "store-selected": true, "store-fake-ip": true }, // è®°ä½ä½ ä¸Šæ¬¡é€‰çš„èŠ‚ç‚¹
Â  Â  Â  Â  "sniffer": { "enable": true, "sniff": { "TLS": { "ports": [443, 8443] }, "HTTP": { "ports": [80, "8080-8880"], "override-destination": true } } },
Â  Â  Â  Â  "geodata-mode": true, // å¼€å¯æ–°ç‰ˆ geodata æ¨¡å¼
Â  Â  Â  Â  "geox-url": accelURLs, // åº”ç”¨åŠ é€Ÿåœ°å€
Â  Â  };

Â  Â  params.dns = { ...params.dns, ...dnsOptions };
Â  Â  Object.keys(otherOptions).forEach((key) => { params[key] = otherOptions[key]; });
}

// ================= è¾…åŠ©å‡½æ•° =================
function getProxiesByRegex(params, regex) {
Â  Â  // ç®€å•çš„è¿‡æ»¤å™¨ï¼šç»™æˆ‘é…ç½®é‡Œçš„æ‰€æœ‰èŠ‚ç‚¹ -> åªè¦åå­—ç¬¦åˆæ­£åˆ™çš„ -> è¿”å›žåå­—åˆ—è¡¨
Â  Â  return params.proxies
Â  Â  Â  Â  .filter((e) => e.name.match(regex))
Â  Â  Â  Â  .map((e) => e.name);
}