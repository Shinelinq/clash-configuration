// =============================================================================
// 0) å…¨å±€å¸¸é‡åŒºï¼šç»Ÿä¸€çš„â€œé…ç½®å¼€å…³ + ç­–ç•¥å­—å…¸â€
//    ç›®æ ‡ï¼šæŠŠæ‰€æœ‰å¯è°ƒå‚æ•°é›†ä¸­åœ¨é¡¶éƒ¨ï¼Œåç»­é€»è¾‘åªå¼•ç”¨è¿™é‡Œï¼Œé¿å…æ•£è½ç¡¬ç¼–ç ã€‚
// =============================================================================

// é»˜è®¤æ€»å‡ºå£ç­–ç•¥ç»„åï¼š
// - è§„åˆ™æœªå‘½ä¸­æ—¶ï¼ˆMATCHï¼‰ä¼šèµ°è¿™é‡Œ
// - è§„åˆ™ç»„é€‰æ‹© PROXY æ—¶ä¹Ÿä¼šæœ€ç»ˆæŒ‡å‘è¿™é‡Œ
const PROXY_NAME = "Proxy";

// èŠ‚ç‚¹æµ‹é€Ÿå‚æ•°ï¼šç”¨äº url-test / Auto ç»„çš„å¥åº·æ£€æŸ¥
// TEST_URLï¼šè½»é‡ 204 è¿”å›ï¼Œé€‚åˆä½œä¸ºè¿é€šæ€§ä¸å»¶è¿Ÿæ¢æµ‹
// TEST_INTERVALï¼šæµ‹é€Ÿå‘¨æœŸï¼ˆç§’ï¼‰ï¼Œè¿‡çŸ­ä¼šç»™æœºåœº/å®¢æˆ·ç«¯é€ æˆå‹åŠ›
// TEST_TOLERANCEï¼šå®¹å·®ï¼ˆmsï¼‰ï¼Œé¿å…å› è½»å¾®æŠ–åŠ¨å¯¼è‡´é¢‘ç¹åˆ‡æ¢
const TEST_URL = "https://cp.cloudflare.com/generate_204";
const TEST_INTERVAL = 600;
const TEST_TOLERANCE = 50;

// ===================== æ‰‹åŠ¨èŠ‚ç‚¹ï¼ˆé“¾å¼ä»£ç†å‡ºå£ï¼‰ =====================
// è¯´æ˜ï¼š
// - è¿™é‡Œç»´æŠ¤ä½ æ‰‹åŠ¨æ·»åŠ çš„èŠ‚ç‚¹ï¼ˆä¼šè¢«æ³¨å…¥åˆ° config.proxiesï¼‰
// - æ³¨æ„ï¼šé“¾å¼ä»£ç†æ–¹æ¡ˆä¸­ï¼Œä¸å…è®¸æ‰‹åŠ¨èŠ‚ç‚¹æºå¸¦ dialer-proxyï¼Œè„šæœ¬ä¼šå¼ºåˆ¶æ¸…æ´—æ‰è¯¥å­—æ®µ
// - é“¾å¼ä½“ç³»å¯ç”¨æ¡ä»¶ï¼ˆç¡¬è§„åˆ™ï¼‰ï¼šæœ€ç»ˆæˆåŠŸæ³¨å…¥çš„æ‰‹åŠ¨èŠ‚ç‚¹æ•°é‡ > 0ï¼Œå¦åˆ™ä¸ç”Ÿæˆä»»ä½•é“¾å¼ç›¸å…³ç»„
const MANUAL_RENAME_SUFFIX = " (Manual)";

// ä½ çš„æ‰‹åŠ¨èŠ‚ç‚¹åˆ—è¡¨ï¼šä¸ºç©ºåˆ™å®Œå…¨ä¸å¯ç”¨é“¾å¼ä»£ç†ä½“ç³»ï¼ˆå…¥å£/å‡ºå£/relay éƒ½ä¸ç”Ÿæˆï¼‰
// ç¤ºä¾‹ï¼ˆè¯·è‡ªè¡Œå¡«å†™ server/port/è´¦å·ç­‰ï¼‰ï¼š
// const MANUAL_PROXIES = [
//   {
//     name: "ç¾å›½ä½å®…ä»£ç†",
//     type: "socks5",
//     server: "your.domain.or.ip",
//     port: 12345,
//     username: "user",
//     password: "pass",
//     udp: true,
//   },
// ];
const MANUAL_PROXIES = [];

// ===================== é“¾å¼ä»£ç†ï¼ˆrelayï¼‰åˆ†ç»„å‘½å =====================
// ç›®æ ‡ï¼šå®Œå…¨ UI å¯æ§å…¥å£/å‡ºå£ï¼Œä¸ä¾èµ– dialer-proxy
// - â€œé“¾è·¯å…¥å£ï¼ˆä¸­è½¬èŠ‚ç‚¹ï¼‰â€ï¼šä»…åŒ…å« ğŸŒ Auto + normalProxies + DIRECT
// - â€œé“¾è·¯å‡ºå£ï¼ˆæ‰‹åŠ¨æ·»åŠ ï¼‰â€ï¼šä»…åŒ…å«æ‰‹åŠ¨èŠ‚ç‚¹æœ¬ä½“ï¼ˆä¸å« DIRECTï¼Œä¿æŒè¯­ä¹‰çº¯å‡€ï¼‰
// - â€œé“¾å¼ä»£ç†â€ï¼šrelay ç»„ï¼Œä»…å¼•ç”¨å…¥å£ç»„ä¸å‡ºå£ç»„
const CHAIN_ENTRY_GROUP_NAME = "é“¾è·¯å…¥å£ï¼ˆä¸­è½¬èŠ‚ç‚¹ï¼‰";
const CHAIN_EXIT_GROUP_NAME = "é“¾è·¯å‡ºå£ï¼ˆæ‰‹åŠ¨æ·»åŠ ï¼‰";
const CHAIN_RELAY_GROUP_NAME = "ğŸ“¡ é“¾å¼ä»£ç†";

// è§„åˆ™ç­–ç•¥é…ç½®è¡¨ï¼š
// key   = è§„åˆ™åˆ†ç»„åç§°ï¼ˆå¿…é¡»ä¸ rule-provider / proxy-group åç§°ä¿æŒä¸€è‡´ï¼‰
// value = é»˜è®¤ç­–ç•¥ï¼š
//   DIRECT -> é»˜è®¤ç›´è¿ï¼ˆå›½å†…/å±€åŸŸç½‘/ä¸å€¼å¾—ä»£ç†çš„æµé‡ï¼‰
//   PROXY  -> é»˜è®¤èµ°ä»£ç†ï¼ˆéœ€è¦åŠ é€Ÿ/ä¸å¯ç›´è¿ï¼‰
//   REJECT -> é»˜è®¤æ‹¦æˆªï¼ˆå¹¿å‘Šç­‰ï¼‰
//
// æ³¨æ„ï¼šè¿™é‡Œåªå®šä¹‰â€œé»˜è®¤è¡Œä¸ºâ€ï¼ŒçœŸæ­£åˆ†æµè§„åˆ™åœ¨ overwriteRules() ä¸­ç”Ÿæˆã€‚
const RULE_CONFIG = {
  "LAN": "DIRECT",            // å±€åŸŸç½‘
  "å›½å†…ç½‘ç«™": "DIRECT",        // å›½å†…ç«™ç‚¹é›†åˆï¼ˆChinaMax æ”¹åï¼‰
  "å…¨çƒåª’ä½“": "PROXY",         // æµ·å¤–åª’ä½“é›†åˆï¼ˆGlobalMedia æ”¹åï¼‰
  "OpenAI": "PROXY",          // ChatGPT / OpenAI ç›¸å…³
  "Gemini": "PROXY",          // Google Gemini ç›¸å…³
  "Google": "PROXY",          // Google
  "linux.do": "PROXY",        // æœ¬åœ°è‡ªå®šä¹‰åŸŸåï¼ˆä»… 1 æ¡å•ç‹¬è§„åˆ™ï¼‰
  "GitHub": "PROXY",          // GitHub
  "SteamCN": "DIRECT",        // Steam å›½å†…éƒ¨åˆ†ï¼ˆå•†åº—/å›½åŒºç›¸å…³ï¼‰
  "Steam": "PROXY",           // Steam å›½é™…/ç¤¾åŒºç­‰
  "PayPal": "PROXY",          // PayPal
  "å¹¿å‘Šæ‹¦æˆª": "REJECT",        // å¹¿å‘Š/è¿½è¸ªåŸŸåé›†åˆ
};

// åˆ†ç»„å›¾æ ‡æ˜ å°„ï¼šç»Ÿä¸€ç®¡ç†ç­–ç•¥ç»„ iconï¼ˆä»…æ³¨å…¥ï¼Œä¸æ”¹å˜ç»„ç”Ÿæˆé€»è¾‘ï¼‰
// key å¿…é¡»ä¸ proxy-group çš„ name å®Œå…¨ä¸€è‡´ï¼Œå¦åˆ™åŒ¹é…ä¸åˆ°
const GROUP_ICONS = {
  // æ€»å‡ºå£ä¸è‡ªåŠ¨æµ‹é€Ÿç»„
  "Proxy": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Proxy.png",
  "ğŸŒ Auto": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Auto.png",

  // è§„åˆ™åˆ†ç»„
  "LAN": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/WiFi.png",

  // Qure Color é‡Œæ²¡æœ‰ GlobalMedia.pngï¼Œå› æ­¤â€œå…¨çƒåª’ä½“â€æ”¹ç”¨ ForeignMedia å›¾æ ‡
  "å…¨çƒåª’ä½“": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/ForeignMedia.png",

  "å›½å†…ç½‘ç«™": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/China.png",
  "å¹¿å‘Šæ‹¦æˆª": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Reject.png",

  "OpenAI": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/ChatGPT.png",
  "Gemini": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/AI.png",

  "linux.do": "https://linux.do/uploads/default/original/3X/9/d/9dd49731091ce8656e94433a26a3ef36062b3994.png",

  "GitHub": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/GitHub.png",
  "Google": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Google.png",

  "SteamCN": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Steam.png",
  "Steam": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Steam.png",

  "PayPal": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/PayPal.png",

  // é“¾å¼ä»£ç†ç›¸å…³
  [CHAIN_ENTRY_GROUP_NAME]: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Rocket.png",
  [CHAIN_EXIT_GROUP_NAME]: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Server.png",
  [CHAIN_RELAY_GROUP_NAME]: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Loop.png",

  // åœ°åŒºæµ‹é€Ÿç»„ï¼ˆå¿…é¡»ä¸ regionProxyGroups çš„ name å®Œå…¨ä¸€è‡´ï¼‰
  "ğŸ‡­ğŸ‡° Hong Kong": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/Hong_Kong.png",
  "ğŸ‡¸ğŸ‡¬ Singapore": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/Singapore.png",
  "ğŸ‡¯ğŸ‡µ Japan": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/Japan.png",
  "ğŸ‡ºğŸ‡¸ United States": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/United_States.png",
};


// =============================================================================
// 1) ä¸»æµç¨‹ï¼šå…¥å£ä¸â€œä»£ç†åæ”¶é›†â€
//    Clash Verge / æŸäº›å®¢æˆ·ç«¯ä¼šæŠŠä»£ç†æ”¾åœ¨ proxiesï¼Œä¹Ÿå¯èƒ½æ¥è‡ª proxy-providersã€‚
//    è¿™é‡Œç»Ÿä¸€æ”¶é›†ä»£ç†åç§°ï¼Œä¾›åˆ†ç»„ä¸æµ‹é€Ÿä½¿ç”¨ã€‚
// =============================================================================
function getAllProxyNames(config) {
  // åˆå¹¶æ”¶é›†ï¼ˆé‡è¦ï¼‰ï¼šé¿å…æ³¨å…¥æ‰‹åŠ¨èŠ‚ç‚¹åˆ° proxies åé®è”½ provider èŠ‚ç‚¹
  const names = [];

  // proxies å­—æ®µ
  if (Array.isArray(config.proxies) && config.proxies.length) {
    names.push(...config.proxies.map(p => p && p.name).filter(Boolean));
  }

  // proxy-providers å±•å¼€çš„ proxies
  const providers = config["proxy-providers"] || {};
  for (const key of Object.keys(providers)) {
    const p = providers[key];
    if (Array.isArray(p.proxies)) {
      names.push(...p.proxies.map(x => x && x.name).filter(Boolean));
    }
  }

  return [...new Set(names)];
}

// æ‰‹åŠ¨èŠ‚ç‚¹æœ€å°æ ¼å¼æ ¡éªŒï¼š
// - ç›®çš„ï¼šé¿å…â€œå†™äº† MANUAL_PROXIES ä½†å…¨éƒ¨æ— æ•ˆâ€ï¼Œå¯¼è‡´å‡ºå£ç»„ç©º
// - è¿™é‡Œä¸åšè¿‡åº¦æ ¡éªŒï¼Œåªä¿è¯æœ€å…³é”®å­—æ®µå­˜åœ¨
function isValidManualProxy(raw) {
  if (!raw || typeof raw !== "object") return false;
  if (!raw.name) return false;
  if (!raw.type) return false;
  if (!raw.server) return false;
  if (raw.port === undefined || raw.port === null || raw.port === "") return false;
  return true;
}

// ä¸»å…¥å£ï¼šæŠŠâ€œå¯åŠ¨æ—¶çš„é»˜è®¤ configâ€åŠ å·¥æˆä½ æƒ³è¦çš„æ ·å­
// é¡ºåºéå¸¸å…³é”®ï¼š
// - overwriteRules/Groups/Dns è´Ÿè´£â€œç»Ÿä¸€æ¡†æ¶â€
// - addCustomRules æœ€åæ’å…¥ä½ çš„æœ¬åœ°ç§è´§ï¼ˆå¹¶æ”¾åˆ° rules æœ€å‰é¢ä¿è¯ä¼˜å…ˆçº§ï¼‰
function main(config) {
  // ---------- æ‰‹åŠ¨èŠ‚ç‚¹æ³¨å…¥ï¼ˆé“¾å¼å‡ºå£èŠ‚ç‚¹æ¥æºï¼‰ ----------
  // ç¡®ä¿ proxies å¯å†™ï¼ˆprovider-only é…ç½®å¯èƒ½æ²¡æœ‰ proxiesï¼‰
  if (!Array.isArray(config.proxies)) config.proxies = [];

  // è®°å½•ï¼šæœ€ç»ˆæ³¨å…¥æˆåŠŸçš„æ‰‹åŠ¨èŠ‚ç‚¹åï¼ˆç”¨äºåç»­åˆ†å±‚ï¼šmanual vs normalï¼‰
  const manualNames = [];

  // æ³¨å…¥æ‰‹åŠ¨èŠ‚ç‚¹ï¼šå¤„ç†æ’å + å¼ºåˆ¶æ¸…æ´— dialer-proxy + æœ€å°æ ¡éªŒ
  if (Array.isArray(MANUAL_PROXIES) && MANUAL_PROXIES.length > 0) {
    const existingNames = new Set(getAllProxyNames(config));

    for (const raw of MANUAL_PROXIES) {
      if (!isValidManualProxy(raw)) continue;

      // å¤åˆ¶ä¸€ä»½ï¼Œé¿å…å¤–éƒ¨å¸¸é‡è¢«æ„å¤–æ”¹åŠ¨
      const p = { ...raw };

      // å¼ºåˆ¶æ¸…æ´—ï¼šé“¾å¼æ–¹æ¡ˆä¸­ä¸å…è®¸ dialer-proxyï¼ˆå…¥å£ç”± UI æ§åˆ¶ï¼‰
      if ("dialer-proxy" in p) {
        try { delete p["dialer-proxy"]; } catch (_) { p["dialer-proxy"] = undefined; }
      }

      // æ’åæ¶ˆè§£ï¼šä»…å¯¹æ‰‹åŠ¨èŠ‚ç‚¹ç”Ÿæ•ˆã€ä¸€æ¬¡æ€§ç¨³å®šæ”¹å
      let finalName = String(p.name);
      if (existingNames.has(finalName)) {
        let i = 1;
        let candidate = `${finalName}${MANUAL_RENAME_SUFFIX}`;
        while (existingNames.has(candidate)) {
          i += 1;
          candidate = `${finalName}${MANUAL_RENAME_SUFFIX}-${i}`;
        }
        finalName = candidate;
        p.name = finalName;
      }

      existingNames.add(finalName);
      manualNames.push(finalName);
      config.proxies.push(p);
    }
  }

  // å°†â€œæ‰‹åŠ¨èŠ‚ç‚¹ååˆ—è¡¨â€æŒ‚åˆ° config ä¸Šï¼Œä¾›åç»­æµç¨‹ä½¿ç”¨ï¼ˆåˆ†å±‚/æ’é™¤/é“¾å¼ç”Ÿæˆï¼‰
  config._manualProxyNames = manualNames;

  // ---------- ç»§ç»­åŸæœ‰æµç¨‹ï¼šæ”¶é›†èŠ‚ç‚¹å ----------
  const allProxies = getAllProxyNames(config);

  // å¦‚æœæ²¡æœ‰æ‹¿åˆ°ä»»ä½•èŠ‚ç‚¹åç§°ï¼Œè¯´æ˜å½“å‰é…ç½®æœªå±•å¼€/æ— èŠ‚ç‚¹ï¼Œç›´æ¥åŸæ ·è¿”å›
  if (!allProxies.length) return config;

  // å°†â€œå…¨éƒ¨ä»£ç†åâ€æŒ‚åˆ° config ä¸Šï¼Œæ–¹ä¾¿åç»­å‡½æ•°åœ¨ provider åœºæ™¯ä¸‹ä¹Ÿèƒ½ä½¿ç”¨
  config._allProxyNames = allProxies;

  // æµæ°´çº¿åŠ å·¥ï¼šæ¯ä¸€æ­¥éƒ½è¦†ç›–/ç”Ÿæˆç‰¹å®šå­—æ®µ
  overwriteRules(config);        // 3) ç”Ÿæˆ rule-providers + rules
  overwriteProxyGroups(config);  // 4) ç”Ÿæˆ proxy-groupsï¼ˆå«åœ°åŒºæµ‹é€Ÿç»„ä¸è§„åˆ™ç»„ + é“¾å¼ä»£ç†ç»„ï¼‰
  overwriteDns(config);          // 5) è¦†å†™ DNS ä¸ç›¸å…³é«˜çº§é€‰é¡¹
  addCustomRules(config);        // 2) æŠŠè‡ªå®šä¹‰è§„åˆ™æ’åˆ°æœ€å‰é¢ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

  return config;
}


// =============================================================================
// 2) è‡ªå®šä¹‰è§„åˆ™ï¼šä½ çš„â€œæœ¬åœ°ç‰¹æƒé€šé“â€
//    è¿™é‡Œæ”¾æœ€æƒ³ä¼˜å…ˆå‘½ä¸­çš„è§„åˆ™ï¼ˆä¾‹å¦‚è‡ªå·±çš„å¸¸ç”¨ç«™ç‚¹ï¼‰ï¼Œä¼šæ’åˆ° rules æœ€å‰é¢ã€‚
// =============================================================================
function addCustomRules(config) {
  const customRules = [
    // linux.doï¼šæ˜ç¡®æŒ‡å®šèµ° linux.do è¿™ä¸ªç­–ç•¥ç»„ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
    "DOMAIN-SUFFIX,linux.do,linux.do",
  ];

  // è‡ªå®šä¹‰è§„åˆ™æ”¾åœ¨æœ€å‰ï¼šç¡®ä¿ä¼˜å…ˆå‘½ä¸­ï¼Œä¸è¢«åé¢çš„è¿œç¨‹è§„åˆ™è¦†ç›–
  config["rules"] = [...customRules, ...config["rules"]];
}


// =============================================================================
// 3) è§„åˆ™ä¸è§„åˆ™é›†ï¼ˆrule-providers + rulesï¼‰
//    - ruleUrlMapï¼šæ¯ä¸ªç­–ç•¥ç»„å¯¹åº”ä¸€ä¸ªè¿œç¨‹è§„åˆ™é›†åœ°å€
//    - generatedProvidersï¼šæ ¹æ® RULE_CONFIG ç”Ÿæˆ providers
//    - optimizedRulesï¼šæœ€ç»ˆçš„ rules é¡ºåºï¼ˆå«æœ¬åœ° LAN ç¡¬å…œåº• + å„ RULE-SET + MATCHï¼‰
// =============================================================================
function overwriteRules(params) {
  // è§„åˆ™é›†åœ°å€æ˜ å°„ï¼škey å¿…é¡»ä¸ RULE_CONFIG å¯¹åº”
  const ruleUrlMap = {
    "LAN": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan_No_Resolve.yaml",

    // ChinaMax æ”¹åä¸ºâ€œå›½å†…ç½‘ç«™â€
    "å›½å†…ç½‘ç«™": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaMax/ChinaMax_Classical_No_IPv6_No_Resolve.yaml",

    "SteamCN": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN_No_Resolve.yaml",
    "OpenAI": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI_No_Resolve.yaml",

    // Geminiï¼šä½¿ç”¨ No_Resolve ç‰ˆæœ¬ï¼Œå‡å°‘ DNS å¹²æ‰°/æ³„éœ²é£é™©
    "Gemini": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Gemini/Gemini_No_Resolve.yaml",

    // GitHubï¼šä½¿ç”¨ No_Resolve ç‰ˆæœ¬
    "GitHub": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/GitHub/GitHub_No_Resolve.yaml",

    "Google": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google_No_Resolve.yaml",
    "PayPal": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/PayPal/PayPal_No_Resolve.yaml",
    "Steam": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Steam/Steam_No_Resolve.yaml",

    // GlobalMedia æ”¹åä¸ºâ€œå…¨çƒåª’ä½“â€
    "å…¨çƒåª’ä½“": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/GlobalMedia/GlobalMedia_Classical_No_Resolve.yaml",

    // å¹¿å‘Šæ‹¦æˆªï¼šä½¿ç”¨ Classical_No_Resolve ç‰ˆæœ¬æ›´ç¨³å¦¥
    "å¹¿å‘Šæ‹¦æˆª": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/AdvertisingLite/AdvertisingLite_Classical_No_Resolve.yaml",
  };

  // æ ¹æ® RULE_CONFIG ç”Ÿæˆ rule-providersï¼ˆåªç”Ÿæˆ ruleUrlMap ä¸­å­˜åœ¨çš„ï¼‰
  const generatedProviders = {};
  Object.keys(RULE_CONFIG).forEach((key) => {
    if (ruleUrlMap[key]) {
      generatedProviders[key] = {
        type: "http",                  // è¿œç¨‹æ‹‰å–
        behavior: "classical",         // classical è§„åˆ™é›†
        url: ruleUrlMap[key],          // è§„åˆ™æºåœ°å€
        path: `./ruleset/${key}.yaml`, // æœ¬åœ°ç¼“å­˜è·¯å¾„
        interval: 86400,               // 1 å¤©æ›´æ–°ä¸€æ¬¡
        format: "yaml",
      };
    }
  });

  // æœ€ç»ˆ rulesï¼šé¡ºåºå³ä¼˜å…ˆçº§ï¼ˆä¸Šé«˜ä¸‹ä½ï¼‰
  // 1) å…ˆæ”¾æœ¬åœ° LAN IP ç¡¬å…œåº•ï¼šå³ä½¿è¿œç¨‹è§„åˆ™å¤±æ•ˆä¹Ÿç¡®ä¿å†…ç½‘ç›´è¿
  // 2) å†æ”¾å„ RULE-SETï¼šæŒ‰ä¸šåŠ¡åˆ†æµ
  // 3) æœ€å MATCHï¼šæ‰€æœ‰æœªå‘½ä¸­æµé‡èµ°æ€»å‡ºå£ PROXY_NAME
  const optimizedRules = [
    // ---- æœ¬åœ° LAN å…œåº•ï¼šä¸ä¾èµ–è¿œç¨‹è§„åˆ™é›† ----
    "IP-CIDR,10.0.0.0/8,DIRECT,no-resolve",
    "IP-CIDR,172.16.0.0/12,DIRECT,no-resolve",
    "IP-CIDR,192.168.0.0/16,DIRECT,no-resolve",
    "IP-CIDR,127.0.0.0/8,DIRECT,no-resolve",
    "IP-CIDR,169.254.0.0/16,DIRECT,no-resolve",
    "DOMAIN-SUFFIX,local,DIRECT",
    "DOMAIN-SUFFIX,lan,DIRECT",

    // ---- è¿œç¨‹è§„åˆ™é›†å¼•ç”¨ï¼šRULE-SET,provider-name,policy-group ----
    "RULE-SET,LAN,DIRECT,no-resolve",
    "RULE-SET,å¹¿å‘Šæ‹¦æˆª,å¹¿å‘Šæ‹¦æˆª,no-resolve",
    "RULE-SET,OpenAI,OpenAI,no-resolve",
    "RULE-SET,Gemini,Gemini,no-resolve",
    "RULE-SET,GitHub,GitHub,no-resolve",
    "RULE-SET,Google,Google,no-resolve",
    "RULE-SET,PayPal,PayPal,no-resolve",
    "RULE-SET,SteamCN,SteamCN,no-resolve",
    "RULE-SET,Steam,Steam,no-resolve",
    "RULE-SET,å…¨çƒåª’ä½“,å…¨çƒåª’ä½“,no-resolve",
    "RULE-SET,å›½å†…ç½‘ç«™,å›½å†…ç½‘ç«™,no-resolve",

    // ---- æœ€ç»ˆå…œåº•ï¼šå…¨éƒ¨æœªå‘½ä¸­æµé‡èµ°æ€»å‡ºå£ ----
    "MATCH," + PROXY_NAME,
  ];

  // åˆå¹¶ï¼ˆä¿ç•™å·²æœ‰ providersï¼Œå†å åŠ ç”Ÿæˆçš„ï¼‰
  params["rule-providers"] = {
    ...(params["rule-providers"] || {}),
    ...generatedProviders,
  };

  // è¦†å†™ rules ä¸ºæœ¬è„šæœ¬ç”Ÿæˆçš„ç‰ˆæœ¬ï¼ˆç¡®ä¿è§„åˆ™é¡ºåºå¯æ§ï¼‰
  params["rules"] = optimizedRules;
}


// =============================================================================
// 4) ç­–ç•¥ç»„ï¼ˆproxy-groupsï¼‰ç”Ÿæˆï¼š
//    - åœ°åŒºæµ‹é€Ÿç»„ï¼šç”¨æ­£åˆ™ä»èŠ‚ç‚¹åä¸­ç­›é€‰é¦™æ¸¯/æ–°åŠ å¡/æ—¥æœ¬/ç¾å›½ï¼ˆé»˜è®¤æ’é™¤æ‰‹åŠ¨èŠ‚ç‚¹ï¼‰
//    - ğŸŒ Autoï¼šåªå¯¹ normalProxies åš url-testï¼ˆæ‰‹åŠ¨èŠ‚ç‚¹æ°¸ä¸å‚ä¸æµ‹é€Ÿï¼‰
//    - é“¾å¼ä»£ç†ç»„ï¼ˆrelayï¼‰ï¼šä»…å½“æ‰‹åŠ¨å‡ºå£èŠ‚ç‚¹æ³¨å…¥æˆåŠŸåç”Ÿæˆï¼ˆç¡¬è§„åˆ™ï¼‰
//      * é“¾è·¯å…¥å£ï¼šğŸŒ Auto + normalProxies + DIRECT
//      * é“¾è·¯å‡ºå£ï¼šä»…æ‰‹åŠ¨èŠ‚ç‚¹æœ¬ä½“
//      * è‡ªå®šä¹‰é“¾å¼ä»£ç†ï¼šrelay(å…¥å£,å‡ºå£)
//    - æ€»å‡ºå£ Proxyï¼šAuto -> (relay å¯é€‰) -> åœ°åŒºç»„ -> normalProxies -> DIRECT
//    - è§„åˆ™ç»„ï¼šæŒ‰ RULE_CONFIG é»˜è®¤ç­–ç•¥ç”Ÿæˆ select ç»„ï¼Œå¹¶åœ¨å¯ç”¨é“¾å¼æ—¶æ³¨å…¥ relay å…¥å£
//    - æœ€åç»Ÿä¸€æ³¨å…¥ iconï¼šä¸æ”¹å˜åŸç»„ç»“æ„ï¼Œåªè¡¥å…¨è§†è§‰ä¿¡æ¯
// =============================================================================
function overwriteProxyGroups(params) {
  // å…¼å®¹ providerï¼šä¼˜å…ˆä½¿ç”¨ main() æŒ‚è½½çš„ _allProxyNames
  const allProxies = params._allProxyNames || (params["proxies"] || []).map((e) => e.name);

  const manualNames = Array.isArray(params._manualProxyNames) ? params._manualProxyNames : [];
  const manualSet = new Set(manualNames);

  // æ‰‹åŠ¨èŠ‚ç‚¹ä¸æ™®é€šèŠ‚ç‚¹åˆ†å±‚
  const manualProxies = allProxies.filter(n => manualSet.has(n));
  const normalProxies = allProxies.filter(n => !manualSet.has(n));

  // âœ… ç¡¬è§„åˆ™ï¼šåªæœ‰å½“â€œæœ€ç»ˆæˆåŠŸæ³¨å…¥çš„æ‰‹åŠ¨èŠ‚ç‚¹â€>0 æ—¶ï¼Œé“¾å¼ä½“ç³»æ‰å¯ç”¨
  const chainEnabled = manualProxies.length > 0;

  // åœ°åŒºåŒ¹é…æ­£åˆ™ï¼š
  // - æ”¯æŒä¸­æ–‡/è‹±æ–‡/æ——å¸œ/å¸¸è§ç¼©å†™
  // - å…è®¸å‘½åä¸­å‡ºç°åˆ†éš”ç¬¦ï¼ˆ- _ ç©ºæ ¼ç­‰ï¼‰
  // - å…è®¸ HK1/HK2 è¿™ç±»æ•°å­—åç¼€
  const regionFilterRegexs = [
    { name: "ğŸ‡­ğŸ‡° Hong Kong", regex: /é¦™æ¸¯|Hong[-\s_]*Kong|HongKong|ğŸ‡­ğŸ‡°|HKG|HK(\d+)?/i },
    { name: "ğŸ‡¸ğŸ‡¬ Singapore", regex: /æ–°åŠ å¡|ç‹®åŸ|Singapore|ğŸ‡¸ğŸ‡¬|SIN|SGP|SG(\d+)?/i },
    { name: "ğŸ‡¯ğŸ‡µ Japan", regex: /æ—¥æœ¬|Japan|ğŸ‡¯ğŸ‡µ|JPN|JP(\d+)?/i },
    { name: "ğŸ‡ºğŸ‡¸ United States", regex: /ç¾å›½|United\s*States|America|ğŸ‡ºğŸ‡¸|USA|US(\d+)?/i },
  ];

  // ç”Ÿæˆåœ°åŒºæµ‹é€Ÿç»„ï¼šurl-test ä¼šè‡ªåŠ¨é€‰æ‹©å»¶è¿Ÿæœ€ä¼˜èŠ‚ç‚¹
  // lazy=trueï¼šä»…åœ¨ä½¿ç”¨è¯¥ç»„æ—¶æ‰è§¦å‘æµ‹é€Ÿï¼Œå‡å°‘æ— æ„ä¹‰æ¢æµ‹
  // æ³¨æ„ï¼šåœ°åŒºç»„çš„å€™é€‰é»˜è®¤æ’é™¤â€œæ‰‹åŠ¨èŠ‚ç‚¹â€ï¼Œé¿å…è¯¯æµ‹/è¯¯é€‰
  const regionProxyGroups = regionFilterRegexs
    .map((item) => {
      const proxies = getProxiesByRegex(params, item.regex);
      return {
        name: item.name,
        type: "url-test",
        url: TEST_URL,
        interval: TEST_INTERVAL,
        tolerance: TEST_TOLERANCE,
        proxies,
        lazy: true,
      };
    })
    // æ²¡åŒ¹é…åˆ°ä»»ä½•èŠ‚ç‚¹çš„åœ°åŒºç»„å°±ä¸ç”Ÿæˆï¼Œé¿å…ç©ºç»„æ±¡æŸ“ç•Œé¢
    .filter((item) => item.proxies.length > 0);

  const regionGroupNames = regionProxyGroups.map((g) => g.name);

  // å…¨å±€è‡ªåŠ¨æµ‹é€Ÿç»„ï¼šåªå¯¹ normalProxies åš url-testï¼ˆæ‰‹åŠ¨èŠ‚ç‚¹æ°¸ä¸å‚ä¸ï¼‰
  const autoSelect = {
    name: "ğŸŒ Auto",
    type: "url-test",
    url: TEST_URL,
    interval: TEST_INTERVAL,
    tolerance: TEST_TOLERANCE,
    proxies: [...normalProxies],
    lazy: true,
  };

  // ---------------- é“¾å¼ä»£ç†ä¸‰ä»¶å¥—ï¼ˆä»… chainEnabled æ—¶ç”Ÿæˆï¼‰ ----------------
  const chainEntryGroup = chainEnabled
    ? {
        name: CHAIN_ENTRY_GROUP_NAME,
        type: "select",
        proxies: ["ğŸŒ Auto", ...normalProxies, "DIRECT"],
      }
    : null;

  const chainExitGroup = chainEnabled
    ? {
        name: CHAIN_EXIT_GROUP_NAME,
        type: "select",
        proxies: [...manualProxies], // å‡ºå£ä¸æ”¾ DIRECTï¼Œä¿æŒè¯­ä¹‰çº¯å‡€
      }
    : null;

  const chainRelayGroup = chainEnabled
    ? {
        name: CHAIN_RELAY_GROUP_NAME,
        type: "relay",
        proxies: [CHAIN_ENTRY_GROUP_NAME, CHAIN_EXIT_GROUP_NAME],
      }
    : null;

  // æ€»å‡ºå£ç»„ï¼šä½ æœ€ç»ˆæ‰‹åŠ¨é€‰æ‹©çš„å…¥å£
  // å€™é€‰é¡ºåºï¼šAuto -> (é“¾å¼ relay å¯é€‰) -> åœ°åŒºç»„ -> normalProxies -> DIRECT
  // æ³¨æ„ï¼šè¿™é‡Œç»ä¸æ”¾æ‰‹åŠ¨èŠ‚ç‚¹æœ¬ä½“
  const proxyGroup = {
    name: PROXY_NAME,
    type: "select",
    proxies: [
      "ğŸŒ Auto",
      ...(chainEnabled ? [CHAIN_RELAY_GROUP_NAME] : []),
      ...regionGroupNames,
      ...normalProxies,
      "DIRECT",
    ],
  };

  // ä¸ºæ¯ä¸ªè§„åˆ™ç­–ç•¥ç»„ç”Ÿæˆä¸€ä¸ª selectï¼šè®©ä½ æ‰‹åŠ¨åˆ‡æ¢è¯¥ç±»æµé‡èµ°å‘
  // ç»„å†…å€™é€‰é¡ºåºä½“ç°â€œé»˜è®¤æ¨èé¡ºåºâ€ï¼Œä½†ä»å¯æ‰‹åŠ¨é€‰æ‹©
  // æ³¨æ„ï¼šå„è§„åˆ™ç»„åªæ³¨å…¥ relayï¼ˆè‹¥å¯ç”¨ï¼‰ï¼Œä¸æ³¨å…¥æ‰‹åŠ¨èŠ‚ç‚¹æœ¬ä½“
  const ruleSetProxyGroups = Object.keys(RULE_CONFIG).map((ruleSetName) => {
    const defaultStrategy = RULE_CONFIG[ruleSetName];
    let proxies;

    // LAN ç»„åªå…è®¸ DIRECTï¼šé¿å…è¯¯æ“ä½œå¯¼è‡´å†…ç½‘ç»•è·¯
    if (ruleSetName === "LAN") {
      proxies = ["DIRECT"];
    } else if (defaultStrategy === "DIRECT") {
      // é»˜è®¤ç›´è¿ï¼šä¼˜å…ˆ DIRECTï¼Œå…¶æ¬¡ Proxyï¼Œå†ç»™ relay/åœ°åŒºç»„ä½œä¸ºå¯é€‰
      proxies = [
        "DIRECT",
        PROXY_NAME,
        ...(chainEnabled ? [CHAIN_RELAY_GROUP_NAME] : []),
        ...regionGroupNames,
      ];
    } else if (defaultStrategy === "REJECT") {
      // æ‹¦æˆªï¼šé»˜è®¤ REJECTï¼ŒåŒæ—¶ç•™ DIRECT/PROXY/relay ä½œä¸ºå®¹é”™
      proxies = [
        "REJECT",
        "DIRECT",
        PROXY_NAME,
        ...(chainEnabled ? [CHAIN_RELAY_GROUP_NAME] : []),
        ...regionGroupNames,
      ];
    } else {
      // é»˜è®¤ä»£ç†ï¼šä¼˜å…ˆ Proxyï¼Œå…¶æ¬¡ relayï¼Œå†åœ°åŒºç»„ï¼Œä¿ç•™ DIRECT åº”æ€¥
      proxies = [
        PROXY_NAME,
        ...(chainEnabled ? [CHAIN_RELAY_GROUP_NAME] : []),
        ...regionGroupNames,
        "DIRECT",
      ];
    }

    return { name: ruleSetName, type: "select", proxies };
  });

  // æ±‡æ€»å†™å›ï¼š
  // 1) æ€»å‡ºå£ Proxy
  // 2) Auto
  // 3) é“¾å¼ä¸‰ä»¶å¥—ï¼ˆå¯é€‰ï¼‰
  // 4) è§„åˆ™ç»„
  // 5) åœ°åŒºæµ‹é€Ÿç»„
  params["proxy-groups"] = [
    proxyGroup,
    autoSelect,
    ...(chainEnabled ? [chainEntryGroup, chainExitGroup, chainRelayGroup] : []),
    ...ruleSetProxyGroups,
    ...regionProxyGroups,
  ].filter(Boolean);

  // ç»Ÿä¸€æ³¨å…¥ iconï¼š
  // - ä¸æ”¹å˜ç»„çš„ proxies/type ç­‰é€»è¾‘
  // - ä»…æ ¹æ®ç»„ååŒ¹é…å›¾æ ‡ï¼ŒåŒ¹é…ä¸åˆ°åˆ™ä¿ç•™åŸ icon
  params["proxy-groups"] = (params["proxy-groups"] || []).map(g => ({
    ...g,
    icon: GROUP_ICONS[g.name] || g.icon,
  }));
}


// =============================================================================
// 5) DNS ä¸é«˜çº§é€‰é¡¹ï¼š
//    ç›®æ ‡ï¼š
//    - fake-ip + respect-rulesï¼šè®© DNS è¡Œä¸ºä¸åˆ†æµè§„åˆ™å¯¹é½ï¼Œå‡å°‘æ³„éœ²
//    - å›½å†…ç«™ç‚¹ç”¨å›½å†… DNSï¼ˆproxy-server-nameserver / policyï¼‰
//    - éå›½å†…ç”¨ DoHï¼ˆnameserverï¼‰æå‡å¯ç”¨æ€§ä¸æŠ—æ±¡æŸ“èƒ½åŠ›
//    åŒæ—¶ç»Ÿä¸€å¼€å¯ä¸€äº›å¸¸ç”¨æ€§èƒ½/ä½“éªŒé€‰é¡¹ï¼ˆunified-delayã€sniffer ç­‰ï¼‰
// =============================================================================
function overwriteDns(params) {
  // å›½å†… DNSï¼šç”¨äºå¤„ç†å›½å†…åŸŸåè§£æï¼Œé¿å…ç»•è·¯/è§£ææ…¢
  const cnDnsList = [
    "223.5.5.5", "223.6.6.6",
    "119.29.29.29", "119.28.28.28",
  ];

  // å¯ä¿¡ DoHï¼šç”¨äºå›½é™…åŸŸåè§£æï¼Œé™ä½æ±¡æŸ“æ¦‚ç‡
  const trustDnsList = [
    "https://cloudflare-dns.com/dns-query",
    "https://dns.google/dns-query",
    "https://1.1.1.1/dns-query",
    "https://8.8.4.4/dns-query",
  ];

  const dnsOptions = {
    "enable": true,
    "ipv6": false,
    "prefer-h3": true,

    "enhanced-mode": "fake-ip",
    "fake-ip-range": "198.18.0.1/16",

    "fake-ip-filter": [
      "*.lan",
      "*.local",
      "localhost",
      "localhost.*",
      "router.asus.com",
      "dns.msftncsi.com",
      "www.msftconnecttest.com",
      "time.*",
      "ntp.*",
      "id.qq.com",
    ],

    "default-nameserver": ["223.5.5.5", "119.29.29.29"],
    "nameserver": trustDnsList,

    "proxy-server-nameserver": cnDnsList,
    "respect-rules": true,

    "nameserver-policy": {
      "geosite:cn": cnDnsList,
      "geosite:geolocation-!cn": trustDnsList,
    },
  };

  // Geo æ•°æ®åº“ä¸‹è½½åœ°å€ï¼š
  const rawGeoxURLs = {
    "geoip": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat",
    "geosite": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat",
    "mmdb": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb",
  };
  const githubPrefix = "https://fastgh.lainbo.com/";
  const accelURLs = Object.fromEntries(
    Object.entries(rawGeoxURLs).map(([key, githubUrl]) => [
      key, `${githubPrefix}${githubUrl}`,
    ])
  );

  const otherOptions = {
    "unified-delay": true,
    "tcp-concurrent": true,
    "profile": { "store-selected": true, "store-fake-ip": true },
    "sniffer": {
      "enable": true,
      "sniff": {
        "TLS": { "ports": [443, 8443] },
        "HTTP": { "ports": [80, "8080-8880"], "override-destination": true }
      }
    },
    "geodata-mode": true,
    "geox-url": accelURLs,
  };

  params.dns = { ...params.dns, ...dnsOptions };
  Object.keys(otherOptions).forEach((key) => { params[key] = otherOptions[key]; });
}


// =============================================================================
// è¾…åŠ©å‡½æ•°ï¼šæŒ‰æ­£åˆ™ç­›é€‰èŠ‚ç‚¹å
// - provider åœºæ™¯ä¼˜å…ˆç”¨ _allProxyNames
// - é»˜è®¤æ’é™¤â€œæ‰‹åŠ¨èŠ‚ç‚¹â€ï¼ˆé“¾å¼æ–¹æ¡ˆç¡¬çº¦æŸï¼šæ‰‹åŠ¨èŠ‚ç‚¹ä¸è¿›å…¥åœ°åŒºæµ‹é€Ÿ/Auto ç­‰æµ‹é€Ÿä½“ç³»ï¼‰
// =============================================================================
function getProxiesByRegex(params, regex) {
  const names = params._allProxyNames || (params.proxies || []).map((e) => e.name);
  const manualNames = Array.isArray(params._manualProxyNames) ? params._manualProxyNames : [];
  const manualSet = new Set(manualNames);

  const base = manualNames.length > 0
    ? names.filter(n => !manualSet.has(n))
    : names;

  return base.filter((name) => regex.test(name));
}
