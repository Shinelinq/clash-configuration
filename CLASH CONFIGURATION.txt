// =============================================================================
// 0) å…¨å±€å¸¸é‡åŒºï¼šç»Ÿä¸€çš„â€œé…ç½®å¸¸é‡ + ç­–ç•¥å­—å…¸â€
// -----------------------------------------------------------------------------
// ç›®æ ‡ï¼š
// 1) æŠŠæ‰€æœ‰å¯è°ƒå‚æ•°é›†ä¸­åœ¨é¡¶éƒ¨ï¼Œé¿å…åœ¨é€»è¾‘ä¸­æ•£è½ç¡¬ç¼–ç ã€‚
// 2) è®©è„šæœ¬æ›´å¯è¯»ï¼šçœ‹åˆ°å¸¸é‡å°±èƒ½çŸ¥é“â€œè¿™ä»½é…ç½®åœ¨åšä»€ä¹ˆâ€ã€‚
// 3) åŒä¸€ä»½è„šæœ¬ç”¨äº PC / æ‰‹æœºç«¯æ—¶ï¼Œå°½é‡ä¿è¯è¡Œä¸ºä¸€è‡´ã€‚
// =============================================================================

// ----------------------------- æ€»å‡ºå£ç­–ç•¥ç»„å -----------------------------
// - è§„åˆ™æœªå‘½ä¸­æ—¶ï¼ˆMATCHï¼‰ä¼šèµ°è¿™é‡Œ
// - è§„åˆ™ç»„é€‰æ‹© PROXY æ—¶ä¹Ÿä¼šæœ€ç»ˆæŒ‡å‘è¿™é‡Œ
// - ä½ åœ¨å®¢æˆ·ç«¯ UI ä¸­æœ€ç»ˆä¸»è¦æ“ä½œçš„â€œæ€»å¼€å…³â€
const PROXY_NAME = "Proxy";

// ----------------------------- èŠ‚ç‚¹æµ‹é€Ÿå‚æ•° -----------------------------
// ç”¨äº url-test / Auto ç»„çš„å¥åº·æ£€æŸ¥ï¼š
// - TEST_URLï¼šè½»é‡ 204 è¿”å›ï¼Œé€‚åˆåšè¿é€šæ€§ä¸å»¶è¿Ÿæ¢æµ‹
// - TEST_INTERVALï¼šæµ‹é€Ÿå‘¨æœŸï¼ˆç§’ï¼‰
// - TEST_TOLERANCEï¼šå»¶è¿Ÿå®¹å·®ï¼ˆmsï¼‰ï¼Œå‡å°‘æŠ–åŠ¨å¯¼è‡´çš„é¢‘ç¹åˆ‡æ¢
const TEST_URL = "https://cp.cloudflare.com/generate_204";
const TEST_INTERVAL = 600;
const TEST_TOLERANCE = 50;

// ===================== æ‰‹åŠ¨èŠ‚ç‚¹ï¼ˆé“¾å¼ä»£ç†å‡ºå£ï¼‰ =====================
// è¯´æ˜ï¼š
// - MANUAL_PROXIES ç”¨äºç»´æŠ¤ä½ â€œæ‰‹åŠ¨æ·»åŠ â€çš„èŠ‚ç‚¹ï¼ˆä¼šè¢«æ³¨å…¥åˆ° config.proxiesï¼‰ã€‚
// - æœ¬è„šæœ¬çš„é“¾å¼ä»£ç†è®¾è®¡ï¼š
//   * æœºåœº/è®¢é˜…èŠ‚ç‚¹ä½œä¸ºâ€œå…¥å£ï¼ˆEntryï¼‰â€æˆ–æ™®é€šå‡ºå£ï¼ˆnormalProxiesï¼‰
//   * æ‰‹åŠ¨èŠ‚ç‚¹ä½œä¸ºâ€œå‡ºå£ï¼ˆExitï¼‰â€
// - æ³¨æ„ï¼šé“¾å¼ä½“ç³»ä¸­ä¸å…è®¸æ‰‹åŠ¨èŠ‚ç‚¹æºå¸¦ dialer-proxyï¼š
//   å…¥å£åº”ç”± UI æ§åˆ¶ï¼Œè„šæœ¬ä¼šå¼ºåˆ¶æ¸…æ´— dialer-proxy å­—æ®µã€‚
// - é“¾å¼ä½“ç³»å¯ç”¨æ¡ä»¶ï¼ˆç¡¬è§„åˆ™ï¼‰ï¼š
//   â€œæœ€ç»ˆæˆåŠŸæ³¨å…¥çš„æ‰‹åŠ¨èŠ‚ç‚¹æ•°é‡ > 0â€ æ—¶æ‰ç”Ÿæˆé“¾å¼ç›¸å…³ç­–ç•¥ç»„ï¼Œé¿å…ç©ºç»„æ±¡æŸ“ç•Œé¢ã€‚
const MANUAL_RENAME_SUFFIX = " (Manual)";

// ä½ çš„æ‰‹åŠ¨èŠ‚ç‚¹åˆ—è¡¨ï¼šä¸ºç©ºåˆ™å®Œå…¨ä¸å¯ç”¨é“¾å¼ä»£ç†ä½“ç³»ï¼ˆå…¥å£/å‡ºå£/relay éƒ½ä¸ç”Ÿæˆï¼‰
// ç¤ºä¾‹ï¼ˆè¯·è‡ªè¡Œå¡«å†™ server/port/è´¦å·ç­‰ï¼‰ï¼š
// const MANUAL_PROXIES = [
//   {
//     name: "è‡ªå®šä¹‰æ·»åŠ èŠ‚ç‚¹1",
//     type: "socks5",
//     server: "your.domain.or.ip",
//     port: 12345,
//     username: "user",
//     password: "pass",
//     udp: true,
//   },
// ];
const MANUAL_PROXIES = [];

// ===================== é“¾å¼ä»£ç†ï¼ˆrelayï¼‰åˆ†ç»„å‘½å =====================
// - CHAIN_ENTRY_GROUP_NAMEï¼šé“¾è·¯å…¥å£ï¼ˆä¸­è½¬èŠ‚ç‚¹ï¼‰ï¼šAuto + æ™®é€šèŠ‚ç‚¹ + DIRECT
// - CHAIN_EXIT_GROUP_NAMEï¼šé“¾è·¯å‡ºå£ï¼ˆæ‰‹åŠ¨æ·»åŠ ï¼‰ï¼šä»…æ‰‹åŠ¨èŠ‚ç‚¹ï¼ˆä¸å« DIRECTï¼Œè¯­ä¹‰æ›´çº¯ï¼‰
// - CHAIN_RELAY_GROUP_NAMEï¼šé“¾å¼ä»£ç†ï¼ˆrelayï¼‰ï¼šå¼•ç”¨â€œå…¥å£ç»„ + å‡ºå£ç»„â€
const CHAIN_ENTRY_GROUP_NAME = "é“¾è·¯å…¥å£ï¼ˆä¸­è½¬èŠ‚ç‚¹ï¼‰";
const CHAIN_EXIT_GROUP_NAME = "é“¾è·¯å‡ºå£ï¼ˆæ‰‹åŠ¨æ·»åŠ ï¼‰";
const CHAIN_RELAY_GROUP_NAME = "ğŸ“¡ é“¾å¼ä»£ç†";

// ===================== è§„åˆ™ç­–ç•¥é…ç½®è¡¨ï¼ˆè§„åˆ™ç»„é»˜è®¤è¡Œä¸ºï¼‰ =====================
// key   = è§„åˆ™åˆ†ç»„åç§°ï¼ˆå¿…é¡»ä¸ rule-provider / proxy-group åç§°ä¿æŒä¸€è‡´ï¼‰
// value = é»˜è®¤ç­–ç•¥ï¼š
//   DIRECT -> é»˜è®¤ç›´è¿ï¼ˆå›½å†…/å±€åŸŸç½‘/ä¸å€¼å¾—ä»£ç†çš„æµé‡ï¼‰
//   PROXY  -> é»˜è®¤èµ°ä»£ç†ï¼ˆéœ€è¦åŠ é€Ÿ/ä¸å¯ç›´è¿ï¼‰
//   REJECT -> é»˜è®¤æ‹¦æˆªï¼ˆå¹¿å‘Šç­‰ï¼‰
//
// æ³¨æ„ï¼šè¿™é‡Œåªå®šä¹‰â€œæ¯ä¸ªåˆ†ç»„åœ¨ UI ä¸­çš„é»˜è®¤å€¾å‘â€ã€‚
// çœŸæ­£çš„åˆ†æµè§„åˆ™é¡ºåº/å†…å®¹ç”± overwriteRules() ç»Ÿä¸€ç”Ÿæˆã€‚
const RULE_CONFIG = {
  "LAN": "DIRECT",            // å±€åŸŸç½‘/å†…ç½‘èµ„æºï¼Œå¿…é¡»ç›´è¿ï¼ˆé¿å…å†…ç½‘ç»•è·¯ï¼‰
  "å›½å†…ç½‘ç«™": "DIRECT",        // å›½å†…ç½‘ç«™é›†åˆï¼ˆChinaMax æ”¹åï¼‰ï¼Œé»˜è®¤ç›´è¿
  "å…¨çƒåª’ä½“": "PROXY",         // æµ·å¤–åª’ä½“é›†åˆï¼Œé»˜è®¤èµ°ä»£ç†
  "OpenAI": "PROXY",          // ChatGPT / OpenAI ç›¸å…³ï¼Œé»˜è®¤èµ°ä»£ç†
  "Gemini": "PROXY",          // Google Gemini ç›¸å…³ï¼Œé»˜è®¤èµ°ä»£ç†
  "Google": "PROXY",          // Googleï¼Œé»˜è®¤èµ°ä»£ç†
  "linux.do": "PROXY",        // è‡ªå®šä¹‰åŸŸåï¼ˆæœ¬åœ°ç‰¹æƒè§„åˆ™ï¼‰ï¼Œé»˜è®¤èµ°ä»£ç†
  "GitHub": "PROXY",          // GitHubï¼Œé»˜è®¤èµ°ä»£ç†
  "SteamCN": "DIRECT",        // Steam å›½å†…éƒ¨åˆ†ï¼ˆå•†åº—/å›½åŒºç›¸å…³ï¼‰ï¼Œé»˜è®¤ç›´è¿
  "Steam": "PROXY",           // Steam å›½é™…/ç¤¾åŒºç­‰ï¼Œé»˜è®¤ä»£ç†
  "PayPal": "PROXY",          // PayPalï¼Œé»˜è®¤ä»£ç†
  "å¹¿å‘Šæ‹¦æˆª": "REJECT",        // å¹¿å‘Š/è¿½è¸ªåŸŸåé›†åˆï¼Œé»˜è®¤æ‹¦æˆª
};

// ===================== åˆ†ç»„å›¾æ ‡æ˜ å°„ï¼ˆçº¯ UIï¼Œä¸å½±å“é€»è¾‘ï¼‰ =====================
// - ä»…æ³¨å…¥ icon å­—æ®µï¼Œä¸æ”¹å˜ç»„çš„ proxies/type/é¡ºåºç­‰é€»è¾‘
// - key å¿…é¡»ä¸ proxy-group çš„ name å®Œå…¨ä¸€è‡´ï¼Œå¦åˆ™åŒ¹é…ä¸åˆ°
const GROUP_ICONS = {
  // æ€»å‡ºå£ä¸è‡ªåŠ¨æµ‹é€Ÿç»„
  "Proxy": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Proxy.png",
  "ğŸŒ Auto": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Auto.png",

  // è§„åˆ™åˆ†ç»„
  "LAN": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/WiFi.png",
  // Qure Color é‡Œæ²¡æœ‰ GlobalMedia.pngï¼Œå› æ­¤â€œå…¨çƒåª’ä½“â€ä½¿ç”¨ ForeignMedia å›¾æ ‡
  "å…¨çƒåª’ä½“": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/ForeignMedia.png",
  "å›½å†…ç½‘ç«™": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/China.png",
  "å¹¿å‘Šæ‹¦æˆª": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Reject.png",

  "OpenAI": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/ChatGPT.png",
  "Gemini": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/AI.png",

  "linux.do": "https://linux.do/uploads/default/original/3X/9/d/9dd49731091ce8656e94433a26a3ef36062b3994.png",

  "GitHub": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/GitHub.png",
  "Google": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Google.png",

  "SteamCN": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Steam.png",
  "Steam": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Steam.png",

  "PayPal": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/PayPal.png",

  // é“¾å¼ä»£ç†ç›¸å…³
  [CHAIN_ENTRY_GROUP_NAME]: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Rocket.png",
  [CHAIN_EXIT_GROUP_NAME]: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Server.png",
  [CHAIN_RELAY_GROUP_NAME]: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Loop.png",

  // åœ°åŒºæµ‹é€Ÿç»„ï¼ˆå¿…é¡»ä¸ regionProxyGroups çš„ name å®Œå…¨ä¸€è‡´ï¼‰
  "ğŸ‡­ğŸ‡° Hong Kong": "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Hong_Kong.png",
  "ğŸ‡¸ğŸ‡¬ Singapore": "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Singapore.png",
  "ğŸ‡¯ğŸ‡µ Japan": "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Japan.png",
  "ğŸ‡ºğŸ‡¸ United States": "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/United_States.png",
};


// =============================================================================
// 1) ä¸»æµç¨‹ï¼šå…¥å£ä¸â€œä»£ç†åæ”¶é›†â€
// -----------------------------------------------------------------------------
// èƒŒæ™¯ï¼šä¸åŒå®¢æˆ·ç«¯/è®¢é˜…æ ¼å¼å¯èƒ½æŠŠèŠ‚ç‚¹æ”¾åœ¨ï¼š
// - config.proxies
// - config["proxy-providers"]ï¼ˆprovider å±•å¼€åä¼šæœ‰ proxiesï¼‰
// è¿™é‡Œç»Ÿä¸€æ”¶é›†ä»£ç†åç§°ï¼Œä¾›ï¼šåˆ†ç»„ç”Ÿæˆã€æµ‹é€Ÿã€åœ°åŒºç­›é€‰ä½¿ç”¨ã€‚
// =============================================================================
function getAllProxyNames(config) {
  // åˆå¹¶æ”¶é›†ï¼ˆé‡è¦ï¼‰ï¼šé¿å…æ³¨å…¥æ‰‹åŠ¨èŠ‚ç‚¹åˆ° proxies åé®è”½ provider èŠ‚ç‚¹
  const names = [];

  // proxies å­—æ®µ
  if (Array.isArray(config.proxies) && config.proxies.length) {
    names.push(...config.proxies.map(p => p && p.name).filter(Boolean));
  }

  // proxy-providers å±•å¼€çš„ proxiesï¼ˆæŸäº›å®¢æˆ·ç«¯ä¼šåœ¨è¿è¡Œæ—¶å±•å¼€åˆ° provider å†…ï¼‰
  const providers = config["proxy-providers"] || {};
  for (const key of Object.keys(providers)) {
    const p = providers[key];
    if (Array.isArray(p.proxies)) {
      names.push(...p.proxies.map(x => x && x.name).filter(Boolean));
    }
  }

  // å»é‡åè¿”å›
  return [...new Set(names)];
}

// =============================================================================
// æ‰‹åŠ¨èŠ‚ç‚¹æœ€å°æ ¼å¼æ ¡éªŒ
// -----------------------------------------------------------------------------
// ç›®çš„ï¼šé¿å…â€œå†™äº† MANUAL_PROXIES ä½†å…¨éƒ¨æ— æ•ˆâ€ï¼Œå¯¼è‡´é“¾å¼å‡ºå£ç»„ç©ºã€‚
// è¿™é‡Œåªåšæœ€å…³é”®å­—æ®µçš„å­˜åœ¨æ€§æ ¡éªŒï¼Œä¸åšè¿‡åº¦æ ¡éªŒï¼ˆé¿å…è¯¯ä¼¤ä¸åŒåè®®å­—æ®µå·®å¼‚ï¼‰ã€‚
// =============================================================================
function isValidManualProxy(raw) {
  if (!raw || typeof raw !== "object") return false;
  if (!raw.name) return false;
  if (!raw.type) return false;
  if (!raw.server) return false;
  if (raw.port === undefined || raw.port === null || raw.port === "") return false;
  return true;
}

// =============================================================================
// ä¸»å…¥å£ï¼šæŠŠâ€œå®¢æˆ·ç«¯åŠ è½½åˆ°çš„ configâ€åŠ å·¥æˆä½ æƒ³è¦çš„æœ€ç»ˆé…ç½®
// -----------------------------------------------------------------------------
// é¡ºåºéå¸¸å…³é”®ï¼š
// - overwriteRules / overwriteProxyGroups / overwriteDns è´Ÿè´£â€œæ¡†æ¶åŒ–è¾“å‡ºâ€
// - addCustomRules æœ€åæ’å…¥ä½ çš„æœ¬åœ°ç‰¹æƒè§„åˆ™ï¼Œå¹¶æ”¾åˆ° rules æœ€å‰é¢ä¿è¯ä¼˜å…ˆçº§
// =============================================================================
function main(config) {
  // ---------- (A) æ‰‹åŠ¨èŠ‚ç‚¹æ³¨å…¥ï¼ˆé“¾å¼å‡ºå£èŠ‚ç‚¹æ¥æºï¼‰ ----------
  // ç¡®ä¿ proxies å¯å†™ï¼ˆprovider-only é…ç½®å¯èƒ½æ²¡æœ‰ proxiesï¼‰
  if (!Array.isArray(config.proxies)) config.proxies = [];

  // è®°å½•æœ€ç»ˆæ³¨å…¥æˆåŠŸçš„æ‰‹åŠ¨èŠ‚ç‚¹åï¼ˆç”¨äºåç»­åˆ†å±‚ï¼šmanual vs normalï¼‰
  const manualNames = [];

  // æ³¨å…¥æ‰‹åŠ¨èŠ‚ç‚¹ï¼šå¤„ç†æ’å + å¼ºåˆ¶æ¸…æ´— dialer-proxy + æœ€å°æ ¡éªŒ
  if (Array.isArray(MANUAL_PROXIES) && MANUAL_PROXIES.length > 0) {
    const existingNames = new Set(getAllProxyNames(config));

    for (const raw of MANUAL_PROXIES) {
      if (!isValidManualProxy(raw)) continue;

      // å¤åˆ¶ä¸€ä»½ï¼Œé¿å…å¤–éƒ¨å¸¸é‡è¢«æ„å¤–æ”¹åŠ¨
      const p = { ...raw };

      // å¼ºåˆ¶æ¸…æ´—ï¼šé“¾å¼æ–¹æ¡ˆä¸­ä¸å…è®¸ dialer-proxyï¼ˆå…¥å£ç”± UI æ§åˆ¶ï¼‰
      if ("dialer-proxy" in p) {
        try { delete p["dialer-proxy"]; } catch (_) { p["dialer-proxy"] = undefined; }
      }

      // æ’åæ¶ˆè§£ï¼šä»…å¯¹æ‰‹åŠ¨èŠ‚ç‚¹ç”Ÿæ•ˆã€ä¸€æ¬¡æ€§ç¨³å®šæ”¹å
      let finalName = String(p.name);
      if (existingNames.has(finalName)) {
        let i = 1;
        let candidate = `${finalName}${MANUAL_RENAME_SUFFIX}`;
        while (existingNames.has(candidate)) {
          i += 1;
          candidate = `${finalName}${MANUAL_RENAME_SUFFIX}-${i}`;
        }
        finalName = candidate;
        p.name = finalName;
      }

      existingNames.add(finalName);
      manualNames.push(finalName);
      config.proxies.push(p);
    }
  }

  // å°†â€œæ‰‹åŠ¨èŠ‚ç‚¹ååˆ—è¡¨â€æŒ‚åˆ° config ä¸Šï¼Œä¾›åç»­æµç¨‹ä½¿ç”¨ï¼ˆåˆ†å±‚/æ’é™¤/é“¾å¼ç”Ÿæˆï¼‰
  config._manualProxyNames = manualNames;

  // ---------- (B) æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹å ----------
  const allProxies = getAllProxyNames(config);

  // å¦‚æœæ²¡æœ‰æ‹¿åˆ°ä»»ä½•èŠ‚ç‚¹åç§°ï¼Œè¯´æ˜å½“å‰é…ç½®æœªå±•å¼€/æ— èŠ‚ç‚¹ï¼Œç›´æ¥åŸæ ·è¿”å›
  if (!allProxies.length) return config;

  // å°†â€œå…¨éƒ¨ä»£ç†åâ€æŒ‚åˆ° config ä¸Šï¼Œæ–¹ä¾¿åç»­å‡½æ•°åœ¨ provider åœºæ™¯ä¸‹ä¹Ÿèƒ½ä½¿ç”¨
  config._allProxyNames = allProxies;

  // ---------- (C) æµæ°´çº¿åŠ å·¥ ----------
  overwriteRules(config);        // ç”Ÿæˆ rule-providers + rules
  overwriteProxyGroups(config);  // ç”Ÿæˆ proxy-groupsï¼ˆå«åœ°åŒºæµ‹é€Ÿç»„ä¸è§„åˆ™ç»„ + é“¾å¼ä»£ç†ç»„ï¼‰
  overwriteDns(config);          // è¦†å†™ DNS ä¸ç›¸å…³é«˜çº§é€‰é¡¹
  addCustomRules(config);        // æŠŠè‡ªå®šä¹‰è§„åˆ™æ’åˆ° rules æœ€å‰é¢ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

  return config;
}


// =============================================================================
// 2) è‡ªå®šä¹‰è§„åˆ™ï¼šæœ¬åœ°ç‰¹æƒé€šé“ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
// -----------------------------------------------------------------------------
// è¿™é‡Œæ”¾ä½ â€œæœ€æƒ³ä¼˜å…ˆå‘½ä¸­â€çš„è§„åˆ™ï¼ˆä¾‹å¦‚è‡ªå·±çš„å¸¸ç”¨ç«™ç‚¹ï¼‰ã€‚
// è¿™äº›è§„åˆ™ä¼šæ’åˆ° rules æœ€å‰é¢ï¼Œä¿è¯ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¸è¢«è¿œç¨‹è§„åˆ™è¦†ç›–ã€‚
// =============================================================================
function addCustomRules(config) {
  const customRules = [
    // linux.doï¼šæ˜ç¡®æŒ‡å®šèµ° linux.do è¿™ä¸ªç­–ç•¥ç»„ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
    "DOMAIN-SUFFIX,linux.do,linux.do",
  ];

  config["rules"] = [...customRules, ...config["rules"]];
}


// =============================================================================
// 3) è§„åˆ™ä¸è§„åˆ™é›†ï¼ˆrule-providers + rulesï¼‰
// -----------------------------------------------------------------------------
// - ruleUrlMapï¼šæ¯ä¸ªç­–ç•¥ç»„å¯¹åº”ä¸€ä¸ªè¿œç¨‹è§„åˆ™é›†åœ°å€
// - generatedProvidersï¼šæ ¹æ® RULE_CONFIG ç”Ÿæˆ providers
// - optimizedRulesï¼šæœ€ç»ˆ rules é¡ºåºï¼ˆä¸Šé«˜ä¸‹ä½ï¼‰
//   (1) æœ¬åœ° LAN ç¡¬å…œåº•ï¼šå³ä½¿è¿œç¨‹è§„åˆ™å¤±æ•ˆä¹Ÿç¡®ä¿å†…ç½‘ç›´è¿
//   (2) å„ä¸šåŠ¡ RULE-SETï¼šæŒ‰ä¸šåŠ¡åˆ†æµ
//   (3) å›½å†…ä¸‰å±‚å…œåº•ï¼šæŠŠæ¼ç½‘çš„å›½å†…æµé‡å¯¼å…¥ã€Œå›½å†…ç½‘ç«™ã€UI
//   (4) MATCHï¼šæ‰€æœ‰æœªå‘½ä¸­æµé‡èµ°æ€»å‡ºå£ PROXY_NAME
// =============================================================================
function overwriteRules(params) {
  const ruleUrlMap = {
    "LAN": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan_No_Resolve.yaml",
    "å›½å†…ç½‘ç«™": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaMax/ChinaMax_Classical_No_IPv6_No_Resolve.yaml",
    "SteamCN": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN_No_Resolve.yaml",
    "OpenAI": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI_No_Resolve.yaml",
    "Gemini": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Gemini/Gemini_No_Resolve.yaml",
    "GitHub": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/GitHub/GitHub_No_Resolve.yaml",
    "Google": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google_No_Resolve.yaml",
    "PayPal": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/PayPal/PayPal_No_Resolve.yaml",
    "Steam": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Steam/Steam_No_Resolve.yaml",
    "å…¨çƒåª’ä½“": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/GlobalMedia/GlobalMedia_Classical_No_Resolve.yaml",
    "å¹¿å‘Šæ‹¦æˆª": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/AdvertisingLite/AdvertisingLite_Classical_No_Resolve.yaml",
  };

  // æ ¹æ® RULE_CONFIG ç”Ÿæˆ rule-providersï¼ˆåªç”Ÿæˆ ruleUrlMap ä¸­å­˜åœ¨çš„ï¼‰
  const generatedProviders = {};
  Object.keys(RULE_CONFIG).forEach((key) => {
    if (ruleUrlMap[key]) {
      generatedProviders[key] = {
        type: "http",                  // è¿œç¨‹æ‹‰å–
        behavior: "classical",         // classical è§„åˆ™é›†
        url: ruleUrlMap[key],          // è§„åˆ™æºåœ°å€
        path: `./ruleset/${key}.yaml`, // æœ¬åœ°ç¼“å­˜è·¯å¾„
        interval: 86400,               // 1 å¤©æ›´æ–°ä¸€æ¬¡
        format: "yaml",
      };
    }
  });

  // æœ€ç»ˆ rulesï¼šé¡ºåºå³ä¼˜å…ˆçº§ï¼ˆä¸Šé«˜ä¸‹ä½ï¼‰
  const optimizedRules = [
    // -----------------------------------------------------------------------
    // (1) æœ¬åœ° LAN ç¡¬å…œåº•ï¼šä¸ä¾èµ–è¿œç¨‹è§„åˆ™é›†
    // ç›®çš„ï¼šå³ä½¿è¿œç¨‹è§„åˆ™é›†å¤±æ•ˆï¼Œä¹Ÿä¿è¯å†…ç½‘/æœ¬æœºèµ„æºæ°¸è¿œç›´è¿ã€‚
    // æ³¨æ„ï¼šLAN è§„åˆ™å†™æ­» DIRECTï¼Œä¸å¯¼å…¥ã€Œå›½å†…ç½‘ç«™ã€UIï¼Œ
    //      é˜²æ­¢ä½ æŠŠâ€œå›½å†…ç½‘ç«™â€è¯¯åˆ‡åˆ° Proxy åå¯¼è‡´å†…ç½‘è®¿é—®ç»•è·¯ã€‚
    // -----------------------------------------------------------------------
    "IP-CIDR,10.0.0.0/8,DIRECT,no-resolve",
    "IP-CIDR,172.16.0.0/12,DIRECT,no-resolve",
    "IP-CIDR,192.168.0.0/16,DIRECT,no-resolve",
    "IP-CIDR,127.0.0.0/8,DIRECT,no-resolve",
    "IP-CIDR,169.254.0.0/16,DIRECT,no-resolve",
    "DOMAIN-SUFFIX,local,DIRECT",
    "DOMAIN-SUFFIX,lan,DIRECT",

    // -----------------------------------------------------------------------
    // (2) è¿œç¨‹è§„åˆ™é›†å¼•ç”¨ï¼šæŒ‰ä¸šåŠ¡ä¼˜å…ˆåˆ†æµ
    // è¯´æ˜ï¼šè¿™äº›è§„åˆ™é›†åº”å½“åœ¨â€œå›½å†…å…œåº•â€ä¹‹å‰ï¼Œé¿å…æµ·å¤–ä¸šåŠ¡è¢«è¯¯åˆ¤ä¸ºå›½å†…ã€‚
    // -----------------------------------------------------------------------
    "RULE-SET,LAN,DIRECT,no-resolve",
    "RULE-SET,å¹¿å‘Šæ‹¦æˆª,å¹¿å‘Šæ‹¦æˆª,no-resolve",
    "RULE-SET,OpenAI,OpenAI,no-resolve",
    "RULE-SET,Gemini,Gemini,no-resolve",
    "RULE-SET,GitHub,GitHub,no-resolve",
    "RULE-SET,Google,Google,no-resolve",
    "RULE-SET,PayPal,PayPal,no-resolve",
    "RULE-SET,SteamCN,SteamCN,no-resolve",
    "RULE-SET,Steam,Steam,no-resolve",
    "RULE-SET,å…¨çƒåª’ä½“,å…¨çƒåª’ä½“,no-resolve",
    "RULE-SET,å›½å†…ç½‘ç«™,å›½å†…ç½‘ç«™,no-resolve",

    // -----------------------------------------------------------------------
    // (3) å›½å†…ä¸‰å±‚å…œåº•ï¼šæŠŠâ€œæ¼ç½‘ä½†å®é™…æ˜¯å›½å†…â€çš„æµé‡ç»Ÿä¸€å¯¼å…¥ã€Œå›½å†…ç½‘ç«™ã€UI
    // ç›®çš„ï¼šè§£å†³å¤šç«¯ï¼ˆå°¤å…¶æ‰‹æœº APPï¼‰å¸¸è§çš„â€œåŸŸåæ‚ / ç›´è¿ IP / æ–°åŸŸåæœªæ”¶å½•â€
    //      å¯¼è‡´çš„æ¼åŒ¹é…ï¼Œå¦åˆ™è¿™äº›æµé‡ä¼šæ‰åˆ° MATCH -> Proxyã€‚
    //
    // ä¸‰å±‚å«ä¹‰ï¼š
    // - ç¬¬ä¸€å±‚ï¼šChinaMaxï¼ˆä¸Šä¸€è¡Œ RULE-SET å·²å®Œæˆï¼Œå±äºä¸šåŠ¡çº§å›½å†…é›†åˆï¼‰
    // - ç¬¬äºŒå±‚ï¼šGEOSITE,cnï¼ˆåŸŸååœ°ç†å…œåº•ï¼šåŸŸåè¢«åˆ¤å®šä¸º CN ç›¸å…³ï¼‰
    // - ç¬¬ä¸‰å±‚ï¼šGEOIP,CNï¼ˆIP åœ°ç†å…œåº•ï¼šç›®æ ‡ IP ä½äº CNï¼‰
    //
    // ä¸ºä»€ä¹ˆè¿™é‡ŒæŒ‡å‘ã€Œå›½å†…ç½‘ç«™ã€è€Œä¸æ˜¯å†™æ­» DIRECTï¼Ÿ
    // - ä¿ç•™ UI è¯­ä¹‰ï¼šä½ åªéœ€è¦åœ¨ UI ä¸­æ§åˆ¶â€œå›½å†…ç½‘ç«™â€ä¸€ä¸ªç»„ï¼›
    // - é»˜è®¤å¯é€‰ DIRECTï¼Œå¿…è¦æ—¶ä¹Ÿå¯ä¸´æ—¶åˆ‡åˆ° Proxy/Relay/åœ°åŒºèŠ‚ç‚¹ã€‚
    // -----------------------------------------------------------------------
    "GEOSITE,cn,å›½å†…ç½‘ç«™",
    "GEOIP,CN,å›½å†…ç½‘ç«™,no-resolve",

    // -----------------------------------------------------------------------
    // (4) æœ€ç»ˆå…œåº•ï¼šå…¨éƒ¨æœªå‘½ä¸­æµé‡èµ°æ€»å‡ºå£
    // -----------------------------------------------------------------------
    "MATCH," + PROXY_NAME,
  ];

  // åˆå¹¶ï¼ˆä¿ç•™å·²æœ‰ providersï¼Œå†å åŠ ç”Ÿæˆçš„ï¼‰
  params["rule-providers"] = {
    ...(params["rule-providers"] || {}),
    ...generatedProviders,
  };

  // è¦†å†™ rules ä¸ºæœ¬è„šæœ¬ç”Ÿæˆçš„ç‰ˆæœ¬ï¼ˆç¡®ä¿è§„åˆ™é¡ºåºå¯æ§ï¼‰
  params["rules"] = optimizedRules;
}


// =============================================================================
// 4) ç­–ç•¥ç»„ï¼ˆproxy-groupsï¼‰ç”Ÿæˆ
// -----------------------------------------------------------------------------
// ç”Ÿæˆå†…å®¹ï¼š
// - åœ°åŒºæµ‹é€Ÿç»„ï¼šæŒ‰æ­£åˆ™ä»èŠ‚ç‚¹åç­›é€‰é¦™æ¸¯/æ–°åŠ å¡/æ—¥æœ¬/ç¾å›½ï¼ˆé»˜è®¤æ’é™¤æ‰‹åŠ¨èŠ‚ç‚¹ï¼‰
// - ğŸŒ Autoï¼šå¯¹æ™®é€šèŠ‚ç‚¹åš url-testï¼ˆæ‰‹åŠ¨èŠ‚ç‚¹æ°¸ä¸å‚ä¸æµ‹é€Ÿï¼‰
// - é“¾å¼ä»£ç†ï¼ˆrelayï¼‰ï¼šä»…å½“æ‰‹åŠ¨å‡ºå£èŠ‚ç‚¹æ³¨å…¥æˆåŠŸåç”Ÿæˆ
//   * é“¾è·¯å…¥å£ï¼šğŸŒ Auto + normalProxies + DIRECT
//   * é“¾è·¯å‡ºå£ï¼šä»…æ‰‹åŠ¨èŠ‚ç‚¹
//   * ğŸ“¡ é“¾å¼ä»£ç†ï¼šrelay(å…¥å£ç»„, å‡ºå£ç»„)
// - æ€»å‡ºå£ Proxyï¼šAuto -> (å¯é€‰ chain relay) -> åœ°åŒºç»„ -> normalProxies -> DIRECT
// - è§„åˆ™ç»„ï¼šæŒ‰ RULE_CONFIG é»˜è®¤ç­–ç•¥ç”Ÿæˆ select ç»„ï¼ˆè®©ä½ åœ¨ UI ä¸­å¯æ‰‹åŠ¨åˆ‡æ¢ï¼‰
// - æœ€åç»Ÿä¸€æ³¨å…¥ iconï¼šä»…å¢å¼º UI æ˜¾ç¤ºï¼Œä¸æ”¹å˜ç»„ç»“æ„
// =============================================================================
function overwriteProxyGroups(params) {
  // å…¼å®¹ providerï¼šä¼˜å…ˆä½¿ç”¨ main() æŒ‚è½½çš„ _allProxyNames
  const allProxies = params._allProxyNames || (params["proxies"] || []).map((e) => e.name);

  const manualNames = Array.isArray(params._manualProxyNames) ? params._manualProxyNames : [];
  const manualSet = new Set(manualNames);

  // æ‰‹åŠ¨èŠ‚ç‚¹ä¸æ™®é€šèŠ‚ç‚¹åˆ†å±‚
  const manualProxies = allProxies.filter(n => manualSet.has(n));
  const normalProxies = allProxies.filter(n => !manualSet.has(n));

  // ç¡¬è§„åˆ™ï¼šåªæœ‰å½“â€œæœ€ç»ˆæˆåŠŸæ³¨å…¥çš„æ‰‹åŠ¨èŠ‚ç‚¹â€>0 æ—¶ï¼Œé“¾å¼ä½“ç³»æ‰å¯ç”¨
  const chainEnabled = manualProxies.length > 0;

  // åœ°åŒºåŒ¹é…æ­£åˆ™ï¼ˆæ”¯æŒä¸­æ–‡/è‹±æ–‡/æ——å¸œ/å¸¸è§ç¼©å†™/æ•°å­—åç¼€ï¼‰
  const regionFilterRegexs = [
    { name: "ğŸ‡­ğŸ‡° Hong Kong", regex: /é¦™æ¸¯|Hong[-\s_]*Kong|HongKong|ğŸ‡­ğŸ‡°|HKG|HK(\d+)?/i },
    { name: "ğŸ‡¸ğŸ‡¬ Singapore", regex: /æ–°åŠ å¡|ç‹®åŸ|Singapore|ğŸ‡¸ğŸ‡¬|SIN|SGP|SG(\d+)?/i },
    { name: "ğŸ‡¯ğŸ‡µ Japan", regex: /æ—¥æœ¬|Japan|ğŸ‡¯ğŸ‡µ|JPN|JP(\d+)?/i },
    { name: "ğŸ‡ºğŸ‡¸ United States", regex: /ç¾å›½|United\s*States|America|ğŸ‡ºğŸ‡¸|USA|US(\d+)?/i },
  ];

  // åœ°åŒºæµ‹é€Ÿç»„ï¼šurl-test è‡ªåŠ¨é€‰æ‹©å»¶è¿Ÿæœ€ä¼˜èŠ‚ç‚¹
  // - lazy=trueï¼šä»…åœ¨ä½¿ç”¨è¯¥ç»„æ—¶è§¦å‘æµ‹é€Ÿï¼Œå‡å°‘æ— æ„ä¹‰æ¢æµ‹
  // - é»˜è®¤æ’é™¤æ‰‹åŠ¨èŠ‚ç‚¹ï¼šé¿å…æŠŠâ€œå‡ºå£èŠ‚ç‚¹â€æ··å…¥æµ‹é€Ÿä½“ç³»é€ æˆè¯­ä¹‰æ··ä¹±
  const regionProxyGroups = regionFilterRegexs
    .map((item) => {
      const proxies = getProxiesByRegex(params, item.regex);
      return {
        name: item.name,
        type: "url-test",
        url: TEST_URL,
        interval: TEST_INTERVAL,
        tolerance: TEST_TOLERANCE,
        proxies,
        lazy: true,
      };
    })
    // æ²¡åŒ¹é…åˆ°ä»»ä½•èŠ‚ç‚¹çš„åœ°åŒºç»„å°±ä¸ç”Ÿæˆï¼Œé¿å…ç©ºç»„æ±¡æŸ“ç•Œé¢
    .filter((item) => item.proxies.length > 0);

  const regionGroupNames = regionProxyGroups.map((g) => g.name);

  // å…¨å±€è‡ªåŠ¨æµ‹é€Ÿç»„ï¼šåªå¯¹ normalProxies åš url-testï¼ˆæ‰‹åŠ¨èŠ‚ç‚¹æ°¸ä¸å‚ä¸ï¼‰
  const autoSelect = {
    name: "ğŸŒ Auto",
    type: "url-test",
    url: TEST_URL,
    interval: TEST_INTERVAL,
    tolerance: TEST_TOLERANCE,
    proxies: [...normalProxies],
    lazy: true,
  };

  // ---------------- é“¾å¼ä»£ç†ä¸‰ä»¶å¥—ï¼ˆä»… chainEnabled æ—¶ç”Ÿæˆï¼‰ ----------------
  const chainEntryGroup = chainEnabled
    ? {
        name: CHAIN_ENTRY_GROUP_NAME,
        type: "select",
        proxies: ["ğŸŒ Auto", ...normalProxies, "DIRECT"],
      }
    : null;

  const chainExitGroup = chainEnabled
    ? {
        name: CHAIN_EXIT_GROUP_NAME,
        type: "select",
        proxies: [...manualProxies], // å‡ºå£ä¸æ”¾ DIRECTï¼Œä¿æŒè¯­ä¹‰çº¯å‡€
      }
    : null;

  const chainRelayGroup = chainEnabled
    ? {
        name: CHAIN_RELAY_GROUP_NAME,
        type: "relay",
        proxies: [CHAIN_ENTRY_GROUP_NAME, CHAIN_EXIT_GROUP_NAME],
      }
    : null;

  // æ€»å‡ºå£ç»„ï¼šä½ æœ€ç»ˆæ‰‹åŠ¨é€‰æ‹©çš„å…¥å£
  // å€™é€‰é¡ºåºï¼šAuto -> (é“¾å¼ relay å¯é€‰) -> åœ°åŒºç»„ -> normalProxies -> DIRECT
  // æ³¨æ„ï¼šè¿™é‡Œç»ä¸æ”¾æ‰‹åŠ¨èŠ‚ç‚¹æœ¬ä½“ï¼ˆæ‰‹åŠ¨èŠ‚ç‚¹åªåœ¨é“¾å¼å‡ºå£ç»„é‡Œå‡ºç°ï¼‰
  const proxyGroup = {
    name: PROXY_NAME,
    type: "select",
    proxies: [
      "ğŸŒ Auto",
      ...(chainEnabled ? [CHAIN_RELAY_GROUP_NAME] : []),
      ...regionGroupNames,
      ...normalProxies,
      "DIRECT",
    ],
  };

  // ä¸ºæ¯ä¸ªè§„åˆ™ç­–ç•¥ç»„ç”Ÿæˆä¸€ä¸ª selectï¼šè®©ä½ æ‰‹åŠ¨åˆ‡æ¢è¯¥ç±»æµé‡èµ°å‘
  // æ³¨æ„ï¼šå„è§„åˆ™ç»„åªæ³¨å…¥ relayï¼ˆè‹¥å¯ç”¨ï¼‰ï¼Œä¸æ³¨å…¥æ‰‹åŠ¨èŠ‚ç‚¹æœ¬ä½“
  const ruleSetProxyGroups = Object.keys(RULE_CONFIG).map((ruleSetName) => {
    const defaultStrategy = RULE_CONFIG[ruleSetName];
    let proxies;

    // LAN ç»„åªå…è®¸ DIRECTï¼šé¿å…è¯¯æ“ä½œå¯¼è‡´å†…ç½‘ç»•è·¯
    if (ruleSetName === "LAN") {
      proxies = ["DIRECT"];
    } else if (defaultStrategy === "DIRECT") {
      // é»˜è®¤ç›´è¿ï¼šä¼˜å…ˆ DIRECTï¼Œå…¶æ¬¡ Proxyï¼Œå†ç»™ relay/åœ°åŒºç»„ä½œä¸ºå¯é€‰
      proxies = [
        "DIRECT",
        PROXY_NAME,
        ...(chainEnabled ? [CHAIN_RELAY_GROUP_NAME] : []),
        ...regionGroupNames,
      ];
    } else if (defaultStrategy === "REJECT") {
      // æ‹¦æˆªï¼šé»˜è®¤ REJECTï¼ŒåŒæ—¶ç•™ DIRECT/PROXY/relay ä½œä¸ºå®¹é”™
      proxies = [
        "REJECT",
        "DIRECT",
        PROXY_NAME,
        ...(chainEnabled ? [CHAIN_RELAY_GROUP_NAME] : []),
        ...regionGroupNames,
      ];
    } else {
      // é»˜è®¤ä»£ç†ï¼šä¼˜å…ˆ Proxyï¼Œå…¶æ¬¡ relayï¼Œå†åœ°åŒºç»„ï¼Œä¿ç•™ DIRECT åº”æ€¥
      proxies = [
        PROXY_NAME,
        ...(chainEnabled ? [CHAIN_RELAY_GROUP_NAME] : []),
        ...regionGroupNames,
        "DIRECT",
      ];
    }

    return { name: ruleSetName, type: "select", proxies };
  });

  // æ±‡æ€»å†™å›ï¼š
  params["proxy-groups"] = [
    proxyGroup,
    autoSelect,
    ...(chainEnabled ? [chainEntryGroup, chainExitGroup, chainRelayGroup] : []),
    ...ruleSetProxyGroups,
    ...regionProxyGroups,
  ].filter(Boolean);

  // ç»Ÿä¸€æ³¨å…¥ iconï¼ˆä¸æ”¹å˜ proxies/type ç­‰é€»è¾‘ï¼‰
  params["proxy-groups"] = (params["proxy-groups"] || []).map(g => ({
    ...g,
    icon: GROUP_ICONS[g.name] || g.icon,
  }));
}


// =============================================================================
// 5) DNS ä¸é«˜çº§é€‰é¡¹
// -----------------------------------------------------------------------------
// ç›®æ ‡ï¼š
// - fake-ip + respect-rulesï¼šè®© DNS è¡Œä¸ºä¸åˆ†æµè§„åˆ™å¯¹é½ï¼Œé™ä½æ³„éœ²/æ±¡æŸ“é£é™©
// - å›½å†…åŸŸåä¼˜å…ˆç”¨å›½å†… DNSï¼ˆproxy-server-nameserver / nameserver-policyï¼‰
// - éå›½å†…ä¼˜å…ˆç”¨ DoHï¼ˆnameserverï¼‰æå‡å¯ç”¨æ€§ä¸æŠ—æ±¡æŸ“èƒ½åŠ›
// åŒæ—¶ç»Ÿä¸€å¼€å¯ä¸€äº›å¸¸ç”¨æ€§èƒ½/ä½“éªŒé€‰é¡¹ï¼ˆunified-delayã€snifferã€tcp-concurrent ç­‰ï¼‰
// =============================================================================
function overwriteDns(params) {
  // å›½å†… DNSï¼šç”¨äºå¤„ç†å›½å†…åŸŸåè§£æï¼Œé¿å…ç»•è·¯/è§£ææ…¢
  const cnDnsList = [
    "223.5.5.5", "223.6.6.6",
    "119.29.29.29", "119.28.28.28",
  ];

  // å¯ä¿¡ DoHï¼šç”¨äºå›½é™…åŸŸåè§£æï¼Œé™ä½æ±¡æŸ“æ¦‚ç‡
  const trustDnsList = [
    "https://cloudflare-dns.com/dns-query",
    "https://dns.google/dns-query",
    "https://1.1.1.1/dns-query",
    "https://8.8.4.4/dns-query",
  ];

  const dnsOptions = {
    "enable": true,
    "ipv6": false,
    "prefer-h3": true,

    // fake-ipï¼šé…åˆ sniffer / è§„åˆ™ï¼Œå¯å‡å°‘ DNS æ±¡æŸ“ä¸æ³„éœ²é£é™©
    "enhanced-mode": "fake-ip",
    "fake-ip-range": "198.18.0.1/16",

    // fake-ip-filterï¼šè¿™äº›åŸŸå/åç¼€ä¸è¿›å…¥ fake-ipï¼Œä¿è¯å±€åŸŸç½‘/ç³»ç»Ÿæ¢æµ‹æ­£å¸¸
    "fake-ip-filter": [
      "*.lan",
      "*.local",
      "localhost",
      "localhost.*",
      "router.asus.com",
      "dns.msftncsi.com",
      "www.msftconnecttest.com",
      "time.*",
      "ntp.*",
      "id.qq.com",
    ],

    // default-nameserverï¼šç”¨äº bootstrapï¼ˆé¿å… DoH é¦–æ¬¡è§£æå¤±è´¥ï¼‰
    "default-nameserver": ["223.5.5.5", "119.29.29.29"],

    // nameserverï¼šä¸»è¦è§£æå™¨ï¼ˆè¿™é‡Œä½¿ç”¨ DoHï¼‰
    "nameserver": trustDnsList,

    // proxy-server-nameserverï¼šå½“éœ€è¦ä¸ºä»£ç†æœåŠ¡å™¨åŸŸåè§£ææ—¶ä½¿ç”¨ï¼ˆé€šå¸¸èµ°å›½å†… DNS æ›´ç¨³ï¼‰
    "proxy-server-nameserver": cnDnsList,

    // respect-rulesï¼šè®© DNS è¡Œä¸ºå°Šé‡åˆ†æµè§„åˆ™ï¼Œå‡å°‘â€œè§£æèµ°ä»£ç†/è¯·æ±‚èµ°ç›´è¿â€ç­‰é”™é…
    "respect-rules": true,

    // nameserver-policyï¼šæŒ‰ geosite åˆ†ç±»é€‰æ‹©è§£æå™¨ï¼ˆå›½å†…ç”¨å›½å†… DNSï¼Œå›½å¤–ç”¨ DoHï¼‰
    "nameserver-policy": {
      "geosite:cn": cnDnsList,
      "geosite:geolocation-!cn": trustDnsList,
    },
  };

  // Geo æ•°æ®åº“ä¸‹è½½åœ°å€ï¼ˆgeodata-mode + geox-urlï¼‰
  // - ç”¨äº GEOSITE/GEOIP ç­‰åŒ¹é…èƒ½åŠ›
  const rawGeoxURLs = {
    "geoip": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat",
    "geosite": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat",
    "mmdb": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb",
  };

  // ä½¿ç”¨åŠ é€Ÿå‰ç¼€ï¼ˆé¿å… GitHub ç›´è¿ä¸ç¨³å®šï¼‰
  const githubPrefix = "https://fastgh.lainbo.com/";
  const accelURLs = Object.fromEntries(
    Object.entries(rawGeoxURLs).map(([key, githubUrl]) => [
      key, `${githubPrefix}${githubUrl}`,
    ])
  );

  // å…¶å®ƒå¸¸ç”¨ä½“éªŒ/æ€§èƒ½é€‰é¡¹
  const otherOptions = {
    "unified-delay": true,      // ç»Ÿä¸€å»¶è¿Ÿæ˜¾ç¤ºé€»è¾‘ï¼ˆä½“éªŒæ›´ä¸€è‡´ï¼‰
    "tcp-concurrent": true,     // TCP å¹¶å‘è¿æ¥ï¼ˆæå‡éƒ¨åˆ†åœºæ™¯ä½“éªŒï¼‰
    "profile": { "store-selected": true, "store-fake-ip": true },

    // snifferï¼šå—…æ¢ SNI/HTTP Hostï¼Œæå‡ fake-ip æ¨¡å¼ä¸‹çš„å¯ç”¨æ€§
    "sniffer": {
      "enable": true,
      "sniff": {
        "TLS": { "ports": [443, 8443] },
        "HTTP": { "ports": [80, "8080-8880"], "override-destination": true }
      }
    },

    // geodata-modeï¼šå¯ç”¨ geosite/geoip æ•°æ®åº“èƒ½åŠ›
    "geodata-mode": true,

    // geox-urlï¼šæŒ‡å®š geosite/geoip/mmdb ä¸‹è½½åœ°å€
    "geox-url": accelURLs,
  };

  // å†™å› DNS ä¸å…¶å®ƒé€‰é¡¹ï¼ˆå°½é‡åˆå¹¶ï¼Œä¸ç ´ååŸæœ‰å­—æ®µï¼‰
  params.dns = { ...params.dns, ...dnsOptions };
  Object.keys(otherOptions).forEach((key) => { params[key] = otherOptions[key]; });
}


// =============================================================================
// è¾…åŠ©å‡½æ•°ï¼šæŒ‰æ­£åˆ™ç­›é€‰èŠ‚ç‚¹åï¼ˆé»˜è®¤æ’é™¤æ‰‹åŠ¨èŠ‚ç‚¹ï¼‰
// -----------------------------------------------------------------------------
// - provider åœºæ™¯ä¼˜å…ˆç”¨ _allProxyNames
// - é»˜è®¤æ’é™¤â€œæ‰‹åŠ¨èŠ‚ç‚¹â€ï¼šæ‰‹åŠ¨èŠ‚ç‚¹è¯­ä¹‰æ˜¯â€œé“¾å¼å‡ºå£â€ï¼Œä¸å‚ä¸åœ°åŒºæµ‹é€Ÿ/Auto æµ‹é€Ÿ
// =============================================================================
function getProxiesByRegex(params, regex) {
  const names = params._allProxyNames || (params.proxies || []).map((e) => e.name);
  const manualNames = Array.isArray(params._manualProxyNames) ? params._manualProxyNames : [];
  const manualSet = new Set(manualNames);

  const base = manualNames.length > 0
    ? names.filter(n => !manualSet.has(n))
    : names;

  return base.filter((name) => regex.test(name));
}
