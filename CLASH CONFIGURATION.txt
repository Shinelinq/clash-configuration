// =============================================================================
// 0) å…¨å±€å¸¸é‡åŒºï¼šç»Ÿä¸€çš„â€œé…ç½®å¼€å…³ + ç­–ç•¥å­—å…¸â€
//    ç›®æ ‡ï¼šæŠŠæ‰€æœ‰å¯è°ƒå‚æ•°é›†ä¸­åœ¨é¡¶éƒ¨ï¼Œåç»­é€»è¾‘åªå¼•ç”¨è¿™é‡Œï¼Œé¿å…æ•£è½ç¡¬ç¼–ç ã€‚
// =============================================================================

// é»˜è®¤æ€»å‡ºå£ç­–ç•¥ç»„åï¼š
// - è§„åˆ™æœªå‘½ä¸­æ—¶ï¼ˆMATCHï¼‰ä¼šèµ°è¿™é‡Œ
// - è§„åˆ™ç»„é€‰æ‹© PROXY æ—¶ä¹Ÿä¼šæœ€ç»ˆæŒ‡å‘è¿™é‡Œ
const PROXY_NAME = "Proxy";

// èŠ‚ç‚¹æµ‹é€Ÿå‚æ•°ï¼šç”¨äº url-test / Auto ç»„çš„å¥åº·æ£€æŸ¥
// TEST_URLï¼šè½»é‡ 204 è¿”å›ï¼Œé€‚åˆä½œä¸ºè¿é€šæ€§ä¸å»¶è¿Ÿæ¢æµ‹
// TEST_INTERVALï¼šæµ‹é€Ÿå‘¨æœŸï¼ˆç§’ï¼‰ï¼Œè¿‡çŸ­ä¼šç»™æœºåœº/å®¢æˆ·ç«¯é€ æˆå‹åŠ›
// TEST_TOLERANCEï¼šå®¹å·®ï¼ˆmsï¼‰ï¼Œé¿å…å› è½»å¾®æŠ–åŠ¨å¯¼è‡´é¢‘ç¹åˆ‡æ¢
const TEST_URL = "https://cp.cloudflare.com/generate_204";
const TEST_INTERVAL = 600;
const TEST_TOLERANCE = 50;

// è§„åˆ™ç­–ç•¥é…ç½®è¡¨ï¼š
// key   = è§„åˆ™åˆ†ç»„åç§°ï¼ˆå¿…é¡»ä¸ rule-provider / proxy-group åç§°ä¿æŒä¸€è‡´ï¼‰
// value = é»˜è®¤ç­–ç•¥ï¼š
//   DIRECT -> é»˜è®¤ç›´è¿ï¼ˆå›½å†…/å±€åŸŸç½‘/ä¸å€¼å¾—ä»£ç†çš„æµé‡ï¼‰
//   PROXY  -> é»˜è®¤èµ°ä»£ç†ï¼ˆéœ€è¦åŠ é€Ÿ/ä¸å¯ç›´è¿ï¼‰
//   REJECT -> é»˜è®¤æ‹¦æˆªï¼ˆå¹¿å‘Šç­‰ï¼‰
//
// æ³¨æ„ï¼šè¿™é‡Œåªå®šä¹‰â€œé»˜è®¤è¡Œä¸ºâ€ï¼ŒçœŸæ­£åˆ†æµè§„åˆ™åœ¨ overwriteRules() ä¸­ç”Ÿæˆã€‚
const RULE_CONFIG = {
    "LAN": "DIRECT",            // å±€åŸŸç½‘
    "å›½å†…ç½‘ç«™": "DIRECT",        // å›½å†…ç«™ç‚¹é›†åˆï¼ˆChinaMax æ”¹åï¼‰
    "å…¨çƒåª’ä½“": "PROXY",         // æµ·å¤–åª’ä½“é›†åˆï¼ˆGlobalMedia æ”¹åï¼‰
    "å¹¿å‘Šæ‹¦æˆª": "REJECT",        // å¹¿å‘Š/è¿½è¸ªåŸŸåé›†åˆ
    "OpenAI": "PROXY",          // ChatGPT / OpenAI ç›¸å…³
    "Gemini": "PROXY",          // Google Gemini ç›¸å…³
    "linux.do": "PROXY",        // æœ¬åœ°è‡ªå®šä¹‰åŸŸåï¼ˆä»… 1 æ¡å•ç‹¬è§„åˆ™ï¼‰
    "GitHub": "PROXY",          // GitHub
    "Google": "PROXY",          // Google
    "SteamCN": "DIRECT",        // Steam å›½å†…éƒ¨åˆ†ï¼ˆå•†åº—/å›½åŒºç›¸å…³ï¼‰
    "Steam": "PROXY",           // Steam å›½é™…/ç¤¾åŒºç­‰
    "PayPal": "PROXY",          // PayPal
};


// åˆ†ç»„å›¾æ ‡æ˜ å°„ï¼šç»Ÿä¸€ç®¡ç†ç­–ç•¥ç»„ iconï¼ˆä»…æ³¨å…¥ï¼Œä¸æ”¹å˜ç»„ç”Ÿæˆé€»è¾‘ï¼‰
// key å¿…é¡»ä¸ proxy-group çš„ name å®Œå…¨ä¸€è‡´ï¼Œå¦åˆ™åŒ¹é…ä¸åˆ°
const GROUP_ICONS = {
    // æ€»å‡ºå£ä¸è‡ªåŠ¨æµ‹é€Ÿç»„
    "Proxy": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/Proxy.png",
    "ğŸŒ Auto": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/Auto.png",

    // è§„åˆ™åˆ†ç»„
    "LAN": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/WiFi.png",

    // Qure Color é‡Œæ²¡æœ‰ GlobalMedia.pngï¼Œå› æ­¤â€œå…¨çƒåª’ä½“â€æ”¹ç”¨ ForeignMedia å›¾æ ‡
    "å…¨çƒåª’ä½“": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/ForeignMedia.png",

    "å›½å†…ç½‘ç«™": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/China.png",
    "å¹¿å‘Šæ‹¦æˆª": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/Reject.png",

    "OpenAI": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/ChatGPT.png",
    "Gemini": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/AI.png",

    "linux.do": "https://linux.do/uploads/default/original/3X/9/d/9dd49731091ce8656e94433a26a3ef36062b3994.png",

    "GitHub": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/GitHub.png",
    "Google": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/Google.png",

    "SteamCN": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/Steam.png",
    "Steam": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/Steam.png",

    "PayPal": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/PayPal.png",

    // åœ°åŒºæµ‹é€Ÿç»„ï¼ˆå¿…é¡»ä¸ regionProxyGroups çš„ name å®Œå…¨ä¸€è‡´ï¼‰
    "ğŸ‡­ğŸ‡° Hong Kong": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/Hong_Kong.png",
    "ğŸ‡¸ğŸ‡¬ Singapore": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/Singapore.png",
    "ğŸ‡¯ğŸ‡µ Japan": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/Japan.png",
    "ğŸ‡ºğŸ‡¸ United States": "https://raw.gitmirror.com/koolson/Qure/master/IconSet/Color/United_States.png",
};


// =============================================================================
// 1) ä¸»æµç¨‹ï¼šå…¥å£ä¸â€œä»£ç†åæ”¶é›†â€
//    Clash Verge / æŸäº›å®¢æˆ·ç«¯ä¼šæŠŠä»£ç†æ”¾åœ¨ proxiesï¼Œä¹Ÿå¯èƒ½æ¥è‡ª proxy-providersã€‚
//    è¿™é‡Œç»Ÿä¸€æ”¶é›†ä»£ç†åç§°ï¼Œä¾›åˆ†ç»„ä¸æµ‹é€Ÿä½¿ç”¨ã€‚
// =============================================================================
function getAllProxyNames(config) {
    // æƒ…å†µ 1ï¼šå®¢æˆ·ç«¯ç›´æ¥å±•å¼€åœ¨ proxies å­—æ®µ
    if (Array.isArray(config.proxies) && config.proxies.length) {
        return config.proxies.map(p => p.name);
    }

    // æƒ…å†µ 2ï¼šä»£ç†æ¥è‡ª proxy-providersï¼ˆéƒ¨åˆ†å®¢æˆ·ç«¯ä¼šæŠŠ provider çš„ proxies å±•å¼€å‡ºæ¥ï¼‰
    const providers = config["proxy-providers"] || {};
    const names = [];
    for (const key of Object.keys(providers)) {
        const p = providers[key];
        if (Array.isArray(p.proxies)) {
            names.push(...p.proxies.map(x => x.name));
        }
    }

    // å»é‡åè¿”å›ï¼Œä¿è¯åç»­ç­–ç•¥ç»„ä¸ä¼šé‡å¤æ³¨å…¥åŒåèŠ‚ç‚¹
    return [...new Set(names)];
}

// ä¸»å…¥å£ï¼šæŠŠâ€œå¯åŠ¨æ—¶çš„é»˜è®¤ configâ€åŠ å·¥æˆä½ æƒ³è¦çš„æ ·å­
// é¡ºåºéå¸¸å…³é”®ï¼š
// - overwriteRules/Groups/Dns è´Ÿè´£â€œç»Ÿä¸€æ¡†æ¶â€
// - addCustomRules æœ€åæ’å…¥ä½ çš„æœ¬åœ°ç§è´§ï¼ˆå¹¶æ”¾åˆ° rules æœ€å‰é¢ä¿è¯ä¼˜å…ˆçº§ï¼‰
function main(config) {
    const allProxies = getAllProxyNames(config);

    // å¦‚æœæ²¡æœ‰æ‹¿åˆ°ä»»ä½•èŠ‚ç‚¹åç§°ï¼Œè¯´æ˜å½“å‰é…ç½®æœªå±•å¼€/æ— èŠ‚ç‚¹ï¼Œç›´æ¥åŸæ ·è¿”å›
    if (!allProxies.length) return config;

    // å°†â€œå…¨éƒ¨ä»£ç†åâ€æŒ‚åˆ° config ä¸Šï¼Œæ–¹ä¾¿åç»­å‡½æ•°åœ¨ provider åœºæ™¯ä¸‹ä¹Ÿèƒ½ä½¿ç”¨
    config._allProxyNames = allProxies;

    // æµæ°´çº¿åŠ å·¥ï¼šæ¯ä¸€æ­¥éƒ½è¦†ç›–/ç”Ÿæˆç‰¹å®šå­—æ®µ
    overwriteRules(config);       // 3) ç”Ÿæˆ rule-providers + rules
    overwriteProxyGroups(config); // 4) ç”Ÿæˆ proxy-groupsï¼ˆå«åœ°åŒºæµ‹é€Ÿç»„ä¸è§„åˆ™ç»„ï¼‰
    overwriteDns(config);         // 5) è¦†å†™ DNS ä¸ç›¸å…³é«˜çº§é€‰é¡¹
    addCustomRules(config);       // 2) æŠŠè‡ªå®šä¹‰è§„åˆ™æ’åˆ°æœ€å‰é¢ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

    return config;
}


// =============================================================================
// 2) è‡ªå®šä¹‰è§„åˆ™ï¼šä½ çš„â€œæœ¬åœ°ç‰¹æƒé€šé“â€
//    è¿™é‡Œæ”¾æœ€æƒ³ä¼˜å…ˆå‘½ä¸­çš„è§„åˆ™ï¼ˆä¾‹å¦‚è‡ªå·±çš„å¸¸ç”¨ç«™ç‚¹ï¼‰ï¼Œä¼šæ’åˆ° rules æœ€å‰é¢ã€‚
// =============================================================================
function addCustomRules(config) {
    const customRules = [
        // linux.doï¼šæ˜ç¡®æŒ‡å®šèµ° linux.do è¿™ä¸ªç­–ç•¥ç»„ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
        "DOMAIN-SUFFIX,linux.do,linux.do",
    ];

    // è‡ªå®šä¹‰è§„åˆ™æ”¾åœ¨æœ€å‰ï¼šç¡®ä¿ä¼˜å…ˆå‘½ä¸­ï¼Œä¸è¢«åé¢çš„è¿œç¨‹è§„åˆ™è¦†ç›–
    config["rules"] = [...customRules, ...config["rules"]];
}


// =============================================================================
// 3) è§„åˆ™ä¸è§„åˆ™é›†ï¼ˆrule-providers + rulesï¼‰
//    - ruleUrlMapï¼šæ¯ä¸ªç­–ç•¥ç»„å¯¹åº”ä¸€ä¸ªè¿œç¨‹è§„åˆ™é›†åœ°å€
//    - generatedProvidersï¼šæ ¹æ® RULE_CONFIG ç”Ÿæˆ providers
//    - optimizedRulesï¼šæœ€ç»ˆçš„ rules é¡ºåºï¼ˆå«æœ¬åœ° LAN ç¡¬å…œåº• + å„ RULE-SET + MATCHï¼‰
// =============================================================================
function overwriteRules(params) {
    // è§„åˆ™é›†åœ°å€æ˜ å°„ï¼škey å¿…é¡»ä¸ RULE_CONFIG å¯¹åº”
    const ruleUrlMap = {
        "LAN": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan_No_Resolve.yaml",

        // ChinaMax æ”¹åä¸ºâ€œå›½å†…ç½‘ç«™â€
        "å›½å†…ç½‘ç«™": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaMax/ChinaMax_Classical_No_IPv6_No_Resolve.yaml",

        "SteamCN": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN_No_Resolve.yaml",
        "OpenAI": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI_No_Resolve.yaml",

        // Geminiï¼šä½¿ç”¨ No_Resolve ç‰ˆæœ¬ï¼Œå‡å°‘ DNS å¹²æ‰°/æ³„éœ²é£é™©
        "Gemini": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Gemini/Gemini_No_Resolve.yaml",

        // GitHubï¼šä½¿ç”¨ No_Resolve ç‰ˆæœ¬
        "GitHub": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/GitHub/GitHub_No_Resolve.yaml",

        "Google": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google_No_Resolve.yaml",
        "PayPal": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/PayPal/PayPal_No_Resolve.yaml",
        "Steam": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Steam/Steam_No_Resolve.yaml",

        // GlobalMedia æ”¹åä¸ºâ€œå…¨çƒåª’ä½“â€
        "å…¨çƒåª’ä½“": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/GlobalMedia/GlobalMedia_Classical_No_Resolve.yaml",

        // å¹¿å‘Šæ‹¦æˆªï¼šä½¿ç”¨ Classical_No_Resolve ç‰ˆæœ¬æ›´ç¨³å¦¥
        "å¹¿å‘Šæ‹¦æˆª": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/AdvertisingLite/AdvertisingLite_Classical_No_Resolve.yaml",
    };

    // æ ¹æ® RULE_CONFIG ç”Ÿæˆ rule-providersï¼ˆåªç”Ÿæˆ ruleUrlMap ä¸­å­˜åœ¨çš„ï¼‰
    const generatedProviders = {};
    Object.keys(RULE_CONFIG).forEach((key) => {
        if (ruleUrlMap[key]) {
            generatedProviders[key] = {
                type: "http",               // è¿œç¨‹æ‹‰å–
                behavior: "classical",      // classical è§„åˆ™é›†
                url: ruleUrlMap[key],       // è§„åˆ™æºåœ°å€
                path: `./ruleset/${key}.yaml`, // æœ¬åœ°ç¼“å­˜è·¯å¾„
                interval: 86400,            // 1 å¤©æ›´æ–°ä¸€æ¬¡
                format: "yaml",
            };
        }
    });

    // æœ€ç»ˆ rulesï¼šé¡ºåºå³ä¼˜å…ˆçº§ï¼ˆä¸Šé«˜ä¸‹ä½ï¼‰
    // 1) å…ˆæ”¾æœ¬åœ° LAN IP ç¡¬å…œåº•ï¼šå³ä½¿è¿œç¨‹è§„åˆ™å¤±æ•ˆä¹Ÿç¡®ä¿å†…ç½‘ç›´è¿
    // 2) å†æ”¾å„ RULE-SETï¼šæŒ‰ä¸šåŠ¡åˆ†æµ
    // 3) æœ€å MATCHï¼šæ‰€æœ‰æœªå‘½ä¸­æµé‡èµ°æ€»å‡ºå£ PROXY_NAME
    const optimizedRules = [
        // ---- æœ¬åœ° LAN å…œåº•ï¼šä¸ä¾èµ–è¿œç¨‹è§„åˆ™é›† ----
        "IP-CIDR,10.0.0.0/8,DIRECT,no-resolve",
        "IP-CIDR,172.16.0.0/12,DIRECT,no-resolve",
        "IP-CIDR,192.168.0.0/16,DIRECT,no-resolve",
        "IP-CIDR,127.0.0.0/8,DIRECT,no-resolve",
        "IP-CIDR,169.254.0.0/16,DIRECT,no-resolve",
        "DOMAIN-SUFFIX,local,DIRECT",
        "DOMAIN-SUFFIX,lan,DIRECT",

        // ---- è¿œç¨‹è§„åˆ™é›†å¼•ç”¨ï¼šRULE-SET,provider-name,policy-group ----
        "RULE-SET,LAN,DIRECT,no-resolve",
        "RULE-SET,å¹¿å‘Šæ‹¦æˆª,å¹¿å‘Šæ‹¦æˆª,no-resolve",
        "RULE-SET,OpenAI,OpenAI,no-resolve",
        "RULE-SET,Gemini,Gemini,no-resolve",
        "RULE-SET,GitHub,GitHub,no-resolve",
        "RULE-SET,Google,Google,no-resolve",
        "RULE-SET,PayPal,PayPal,no-resolve",
        "RULE-SET,SteamCN,SteamCN,no-resolve",
        "RULE-SET,Steam,Steam,no-resolve",
        "RULE-SET,å…¨çƒåª’ä½“,å…¨çƒåª’ä½“,no-resolve",
        "RULE-SET,å›½å†…ç½‘ç«™,å›½å†…ç½‘ç«™,no-resolve",

        // ---- æœ€ç»ˆå…œåº•ï¼šå…¨éƒ¨æœªå‘½ä¸­æµé‡èµ°æ€»å‡ºå£ ----
        "MATCH," + PROXY_NAME,
    ];

    // åˆå¹¶ï¼ˆä¿ç•™å·²æœ‰ providersï¼Œå†å åŠ ç”Ÿæˆçš„ï¼‰
    params["rule-providers"] = {
        ...(params["rule-providers"] || {}),
        ...generatedProviders,
    };

    // è¦†å†™ rules ä¸ºæœ¬è„šæœ¬ç”Ÿæˆçš„ç‰ˆæœ¬ï¼ˆç¡®ä¿è§„åˆ™é¡ºåºå¯æ§ï¼‰
    params["rules"] = optimizedRules;
}


// =============================================================================
// 4) ç­–ç•¥ç»„ï¼ˆproxy-groupsï¼‰ç”Ÿæˆï¼š
//    - åœ°åŒºæµ‹é€Ÿç»„ï¼šç”¨æ­£åˆ™ä»èŠ‚ç‚¹åä¸­ç­›é€‰é¦™æ¸¯/æ–°åŠ å¡/æ—¥æœ¬/ç¾å›½
//    - æ€»å‡ºå£ Proxyï¼šåŒ…å« Auto + åœ°åŒºç»„ + å…¨éƒ¨èŠ‚ç‚¹ + DIRECT
//    - è§„åˆ™ç»„ï¼šæŒ‰ RULE_CONFIG é»˜è®¤ç­–ç•¥ç”Ÿæˆ select ç»„
//    - æœ€åç»Ÿä¸€æ³¨å…¥ iconï¼šä¸æ”¹å˜åŸç»„ç»“æ„ï¼Œåªè¡¥å…¨è§†è§‰ä¿¡æ¯
// =============================================================================
function overwriteProxyGroups(params) {
    // å…¼å®¹ providerï¼šä¼˜å…ˆä½¿ç”¨ main() æŒ‚è½½çš„ _allProxyNames
    const allProxies = params._allProxyNames || (params["proxies"] || []).map((e) => e.name);

    // åœ°åŒºåŒ¹é…æ­£åˆ™ï¼š
    // - æ”¯æŒä¸­æ–‡/è‹±æ–‡/æ——å¸œ/å¸¸è§ç¼©å†™
    // - å…è®¸å‘½åä¸­å‡ºç°åˆ†éš”ç¬¦ï¼ˆ- _ ç©ºæ ¼ç­‰ï¼‰
    // - å…è®¸ HK1/HK2 è¿™ç±»æ•°å­—åç¼€
    const regionFilterRegexs = [
        { name: "ğŸ‡­ğŸ‡° Hong Kong", regex: /é¦™æ¸¯|Hong[-\s_]*Kong|HongKong|ğŸ‡­ğŸ‡°|HKG|HK(\d+)?/i },
        { name: "ğŸ‡¸ğŸ‡¬ Singapore", regex: /æ–°åŠ å¡|ç‹®åŸ|Singapore|ğŸ‡¸ğŸ‡¬|SIN|SGP|SG(\d+)?/i },
        { name: "ğŸ‡¯ğŸ‡µ Japan", regex: /æ—¥æœ¬|Japan|ğŸ‡¯ğŸ‡µ|JPN|JP(\d+)?/i },
        { name: "ğŸ‡ºğŸ‡¸ United States", regex: /ç¾å›½|United\s*States|America|ğŸ‡ºğŸ‡¸|USA|US(\d+)?/i },
    ];

    // ç”Ÿæˆåœ°åŒºæµ‹é€Ÿç»„ï¼šurl-test ä¼šè‡ªåŠ¨é€‰æ‹©å»¶è¿Ÿæœ€ä¼˜èŠ‚ç‚¹
    // lazy=trueï¼šä»…åœ¨ä½¿ç”¨è¯¥ç»„æ—¶æ‰è§¦å‘æµ‹é€Ÿï¼Œå‡å°‘æ— æ„ä¹‰æ¢æµ‹
    const regionProxyGroups = regionFilterRegexs
        .map((item) => {
            const proxies = getProxiesByRegex(params, item.regex);
            return {
                name: item.name,
                type: "url-test",
                url: TEST_URL,
                interval: TEST_INTERVAL,
                tolerance: TEST_TOLERANCE,
                proxies,
                lazy: true,
            };
        })
        // æ²¡åŒ¹é…åˆ°ä»»ä½•èŠ‚ç‚¹çš„åœ°åŒºç»„å°±ä¸ç”Ÿæˆï¼Œé¿å…ç©ºç»„æ±¡æŸ“ç•Œé¢
        .filter((item) => item.proxies.length > 0);

    // ä»…æ”¶é›†å·²ç”Ÿæˆåœ°åŒºç»„çš„åå­—ï¼Œç”¨äºæ³¨å…¥åˆ°å…¶å®ƒ select ç»„ä¸­
    const regionGroupNames = regionProxyGroups.map((g) => g.name);

    // ä¸ºæ¯ä¸ªè§„åˆ™ç­–ç•¥ç»„ç”Ÿæˆä¸€ä¸ª selectï¼šè®©ä½ æ‰‹åŠ¨åˆ‡æ¢è¯¥ç±»æµé‡èµ°å‘
    // ç»„å†…å€™é€‰é¡ºåºä½“ç°â€œé»˜è®¤æ¨èé¡ºåºâ€ï¼Œä½†ä»å¯æ‰‹åŠ¨é€‰æ‹©
    const ruleSetProxyGroups = Object.keys(RULE_CONFIG).map((ruleSetName) => {
        const defaultStrategy = RULE_CONFIG[ruleSetName];
        let proxies;

        // LAN ç»„åªå…è®¸ DIRECTï¼šé¿å…è¯¯æ“ä½œå¯¼è‡´å†…ç½‘ç»•è·¯
        if (ruleSetName === "LAN") {
            proxies = ["DIRECT"];
        } else if (defaultStrategy === "DIRECT") {
            // é»˜è®¤ç›´è¿çš„ç»„ï¼šä¼˜å…ˆ DIRECTï¼Œä½†ä¹Ÿå…è®¸åˆ‡ PROXY/åœ°åŒºç»„
            proxies = ["DIRECT", PROXY_NAME, ...regionGroupNames];
        } else if (defaultStrategy === "REJECT") {
            // æ‹¦æˆªç»„ï¼šé»˜è®¤ REJECTï¼ŒåŒæ—¶ç•™ DIRECT/PROXY ä½œä¸ºå®¹é”™
            proxies = ["REJECT", "DIRECT", PROXY_NAME, ...regionGroupNames];
        } else {
            // é»˜è®¤ä»£ç†çš„ç»„ï¼šä¼˜å…ˆæ€»å‡ºå£/åœ°åŒºç»„ï¼Œä½†ä¿ç•™ DIRECT ä»¥ä¾¿åº”æ€¥
            proxies = [PROXY_NAME, ...regionGroupNames, "DIRECT"];
        }

        return { name: ruleSetName, type: "select", proxies };
    });

    // å…¨å±€è‡ªåŠ¨æµ‹é€Ÿç»„ï¼šå¯¹â€œæ‰€æœ‰èŠ‚ç‚¹â€åš url-testï¼Œè‡ªåŠ¨æŒ‘æœ€å¿«
    const autoSelect = {
        name: "ğŸŒ Auto",
        type: "url-test",
        url: TEST_URL,
        interval: TEST_INTERVAL,
        tolerance: TEST_TOLERANCE,
        proxies: [...allProxies],
        lazy: true,
    };

    // æ€»å‡ºå£ç»„ï¼šä½ æœ€ç»ˆæ‰‹åŠ¨é€‰æ‹©çš„å…¥å£
    // å€™é€‰é¡ºåºï¼šAuto -> åœ°åŒºç»„ -> å…¨éƒ¨èŠ‚ç‚¹ -> DIRECT
    const proxyGroup = {
        name: PROXY_NAME,
        type: "select",
        proxies: ["ğŸŒ Auto", ...regionGroupNames, ...allProxies, "DIRECT"],
    };

    // æ±‡æ€»å†™å›ï¼šæ€»å‡ºå£ + Auto + è§„åˆ™ç»„ + åœ°åŒºæµ‹é€Ÿç»„
    params["proxy-groups"] = [
        proxyGroup,
        autoSelect,
        ...ruleSetProxyGroups,
        ...regionProxyGroups,
    ];

    // ç»Ÿä¸€æ³¨å…¥ iconï¼š
    // - ä¸æ”¹å˜ç»„çš„ proxies/type ç­‰é€»è¾‘
    // - ä»…æ ¹æ®ç»„ååŒ¹é…å›¾æ ‡ï¼ŒåŒ¹é…ä¸åˆ°åˆ™ä¿ç•™åŸ icon
    params["proxy-groups"] = (params["proxy-groups"] || []).map(g => ({
        ...g,
        icon: GROUP_ICONS[g.name] || g.icon,
    }));
}


// =============================================================================
// 5) DNS ä¸é«˜çº§é€‰é¡¹ï¼š
//    ç›®æ ‡ï¼š
//    - fake-ip + respect-rulesï¼šè®© DNS è¡Œä¸ºä¸åˆ†æµè§„åˆ™å¯¹é½ï¼Œå‡å°‘æ³„éœ²
//    - å›½å†…ç«™ç‚¹ç”¨å›½å†… DNSï¼ˆproxy-server-nameserver / policyï¼‰
//    - éå›½å†…ç”¨ DoHï¼ˆnameserverï¼‰æå‡å¯ç”¨æ€§ä¸æŠ—æ±¡æŸ“èƒ½åŠ›
//    åŒæ—¶ç»Ÿä¸€å¼€å¯ä¸€äº›å¸¸ç”¨æ€§èƒ½/ä½“éªŒé€‰é¡¹ï¼ˆunified-delayã€sniffer ç­‰ï¼‰
// =============================================================================
function overwriteDns(params) {
    // å›½å†… DNSï¼šç”¨äºå¤„ç†å›½å†…åŸŸåè§£æï¼Œé¿å…ç»•è·¯/è§£ææ…¢
    const cnDnsList = [
        "223.5.5.5", "223.6.6.6",
        "119.29.29.29", "119.28.28.28",
    ];

    // å¯ä¿¡ DoHï¼šç”¨äºå›½é™…åŸŸåè§£æï¼Œé™ä½æ±¡æŸ“æ¦‚ç‡
    const trustDnsList = [
        "https://cloudflare-dns.com/dns-query",
        "https://dns.google/dns-query",
        "https://1.1.1.1/dns-query",
        "https://8.8.4.4/dns-query",
    ];

    // DNS ä¸»ä½“é…ç½®ï¼š
    // - enhanced-mode=fake-ipï¼šæå‡åŸŸåå‘½ä¸­ç‡ä¸è§„åˆ™ä½“éªŒ
    // - fake-ip-filterï¼šè¿™äº›åŸŸåå¿…é¡»èµ°çœŸå® IPï¼ˆå±€åŸŸç½‘/æ¢æµ‹åŸŸå/æ—¶é—´æœåŠ¡ç­‰ï¼‰
    // - nameserverï¼šä¸»è§£æå™¨ï¼ˆè¿™é‡Œä½¿ç”¨ DoHï¼‰
    // - proxy-server-nameserverï¼šèµ°ä»£ç†è§£ææ—¶ä½¿ç”¨çš„ DNSï¼ˆè¿™é‡Œæ”¾å›½å†… DNSï¼‰
    // - respect-rules=trueï¼šè®© DNS ç­–ç•¥å°Šé‡åˆ†æµè§„åˆ™ï¼ˆå…³é”®ï¼ï¼‰
    // - nameserver-policyï¼šæŒ‰ geosite åˆ†ç±»å¯¹ä¸åŒåŸŸåä½¿ç”¨ä¸åŒ DNS
    const dnsOptions = {
        "enable": true,
        "ipv6": false,
        "prefer-h3": true,

        "enhanced-mode": "fake-ip",
        "fake-ip-range": "198.18.0.1/16",

        "fake-ip-filter": [
            "*.lan",
            "*.local",
            "localhost",
            "localhost.*",
            "router.asus.com",
            "dns.msftncsi.com",
            "www.msftconnecttest.com",
            "time.*",
            "ntp.*",
            "id.qq.com",
        ],

        "default-nameserver": ["223.5.5.5", "119.29.29.29"],
        "nameserver": trustDnsList,

        "proxy-server-nameserver": cnDnsList,
        "respect-rules": true,

        "nameserver-policy": {
            "geosite:cn": cnDnsList,
            "geosite:geolocation-!cn": trustDnsList,
        },
    };

    // Geo æ•°æ®åº“ä¸‹è½½åœ°å€ï¼š
    // rawGeoxURLs ä¸ºå®˜æ–¹ GitHub release
    // accelURLs é€šè¿‡åŠ é€Ÿå‰ç¼€æ‹¼æ¥ï¼Œæå‡å›½å†…æ‹‰å–æˆåŠŸç‡
    const rawGeoxURLs = {
        "geoip": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat",
        "geosite": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat",
        "mmdb": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb",
    };
    const githubPrefix = "https://fastgh.lainbo.com/";
    const accelURLs = Object.fromEntries(
        Object.entries(rawGeoxURLs).map(([key, githubUrl]) => [
            key, `${githubPrefix}${githubUrl}`,
        ])
    );

    // å…¶å®ƒæ€§èƒ½/ä½“éªŒé€‰é¡¹ï¼š
    // - unified-delayï¼šå»¶è¿Ÿç»Ÿè®¡æ›´ä¸€è‡´
    // - tcp-concurrentï¼šå¹¶å‘æ¡æ‰‹æå‡ä½“éªŒ
    // - profileï¼šè®°ä½ä¸Šæ¬¡é€‰æ‹©ä¸ fake-ip æ˜ å°„
    // - snifferï¼šåŸºäº SNI/HTTP Host ååŠ©è¯†åˆ«åŸŸåï¼ˆå¯¹åˆ†æµæ›´å‹å¥½ï¼‰
    // - geodata-mode + geox-urlï¼šä½¿ç”¨ geodata å¹¶æŒ‡å®šä¸‹è½½æº
    const otherOptions = {
        "unified-delay": true,
        "tcp-concurrent": true,
        "profile": { "store-selected": true, "store-fake-ip": true },
        "sniffer": {
            "enable": true,
            "sniff": {
                "TLS": { "ports": [443, 8443] },
                "HTTP": { "ports": [80, "8080-8880"], "override-destination": true }
            }
        },
        "geodata-mode": true,
        "geox-url": accelURLs,
    };

    // å†™å› DNSï¼šä¿ç•™åŸ params.dns ä¸­å…¶ä»–å­—æ®µï¼Œå†è¦†ç›–ä¸ºæœ¬è„šæœ¬ç‰ˆæœ¬
    params.dns = { ...params.dns, ...dnsOptions };

    // å°†å…¶å®ƒé¡¶å±‚é€‰é¡¹å†™å›åˆ° paramsï¼ˆè¦†ç›–/æ³¨å…¥ï¼‰
    Object.keys(otherOptions).forEach((key) => { params[key] = otherOptions[key]; });
}


// =============================================================================
// è¾…åŠ©å‡½æ•°ï¼šæŒ‰æ­£åˆ™ç­›é€‰èŠ‚ç‚¹å
// - provider åœºæ™¯ä¼˜å…ˆç”¨ _allProxyNames
// - è¿”å›åŒ¹é…è¯¥åœ°åŒº/å…³é”®å­—çš„èŠ‚ç‚¹åç§°æ•°ç»„
// =============================================================================
function getProxiesByRegex(params, regex) {
    const names = params._allProxyNames || (params.proxies || []).map((e) => e.name);
    return names.filter((name) => regex.test(name));
}
