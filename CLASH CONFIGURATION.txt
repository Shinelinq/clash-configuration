// ================= 0. å…¨å±€å¸¸é‡å®šä¹‰ (è¿™æ˜¯ä½ çš„â€œæˆ˜æœ¯æŒ‡æŒ¥ä¸­å¿ƒâ€) =================

// ä»£ç†æ€»å‡ºå£åç§°ï¼šæ‰€æœ‰çš„è§„åˆ™æ²¡åŒ¹é…åˆ°çš„ï¼Œæˆ–è€…é€‰äº† PROXY çš„ï¼Œæœ€åéƒ½æµå‘è¿™é‡Œ
const PROXY_NAME = "Proxy";

// æµ‹é€Ÿè®¾ç½®ï¼šè¿™æ˜¯ç»™èŠ‚ç‚¹â€œä½“æ£€â€çš„æ ‡å‡†
const TEST_URL = "https://cp.cloudflare.com/generate_204"; // ç»å…¸çš„ CF æµ‹é€Ÿåœ°å€ï¼Œè½»é‡
const TEST_INTERVAL = 300; // æ¯ 300 ç§’ï¼ˆ5åˆ†é’Ÿï¼‰æµ‹ä¸€æ¬¡ï¼Œä¸è‡³äºæŠŠæœºåœºè·‘å´©
const TEST_TOLERANCE = 50; // å®¹å·® 50msï¼Œé˜²æ­¢èŠ‚ç‚¹å› ä¸ºå¾®å°æ³¢åŠ¨é¢‘ç¹åˆ‡æ¢

// è§„åˆ™é›†é…ç½®æ¸…å•ï¼šè¿™æ˜¯ä½ çš„â€œçº¢ç»¿ç¯â€ç­–ç•¥è¡¨
// å·¦è¾¹æ˜¯ç­–ç•¥ç»„åå­—ï¼Œå³è¾¹æ˜¯é»˜è®¤ç­–ç•¥ (DIRECT=ç›´è¿, PROXY=èµ°ä»£ç†, REJECT=æ‹’ç»)
const RULE_CONFIG = {
    // --- é»˜è®¤ç›´è¿ç»„ (å›½å†…æœåŠ¡ï¼Œä¸æµªè´¹æµé‡) ---
    "LAN": "DIRECT",            // å±€åŸŸç½‘
    "å…¨çƒåª’ä½“": "PROXY",         // åŸ GlobalMediaï¼ˆæ”¹ä¸­æ–‡åï¼‰
    "å›½å†…ç½‘ç«™": "DIRECT",        // åŸ ChinaMaxï¼ˆæ”¹ä¸­æ–‡åï¼‰
    "å¹¿å‘Šæ‹¦æˆª": "REJECT",
    "OpenAI": "PROXY",          // ChatGPT
    "Gemini": "PROXY",          // Google Gemini
    "linux.do": "PROXY",        // ä»…ä¸€æ¡æœ¬åœ°è§„åˆ™ï¼šDOMAIN-SUFFIX,linux.do
    "GitHub": "PROXY",          // GitHub
    "Google": "PROXY",
    "SteamCN": "DIRECT",         // Steam å•†åº—é¡µé¢ç­‰å›½å†…éƒ¨åˆ†
    "Steam": "PROXY",
    "PayPal": "PROXY",
};

// ================= 1. ä¸»å‡½æ•°å…¥å£ (è¿™æ˜¯è„šæœ¬çš„å¤§è„‘) =================
function getAllProxyNames(config) {
    // ä¼˜å…ˆç”¨ proxies
    if (Array.isArray(config.proxies) && config.proxies.length) {
        return config.proxies.map(p => p.name);
    }
    // å°è¯•ä» proxy-providers é‡ŒæŠ½ï¼ˆéƒ¨åˆ†å®¢æˆ·ç«¯ä¼šå±•å¼€ï¼‰
    const providers = config["proxy-providers"] || {};
    const names = [];
    for (const key of Object.keys(providers)) {
        const p = providers[key];
        if (Array.isArray(p.proxies)) {
            names.push(...p.proxies.map(x => x.name));
        }
    }
    return [...new Set(names)];
}

// Clash Verge å¯åŠ¨æ—¶ä¼šæŠŠé»˜è®¤é…ç½®å¡ç»™ configï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£æŠŠ config æ”¹é€ æˆä½ è¦çš„æ ·å­
function main(config) {
    const allProxies = getAllProxyNames(config);
    if (!allProxies.length) return config;

    // æŒ‚åˆ° config ä¸Šä¾›åç»­å‡½æ•°ä½¿ç”¨ï¼ˆå…¼å®¹ provider åœºæ™¯ï¼‰
    config._allProxyNames = allProxies;

    // æ¥ä¸‹æ¥åƒæµæ°´çº¿ä¸€æ ·åŠ å·¥é…ç½®ï¼Œé¡ºåºå¾ˆé‡è¦ï¼
    overwriteRules(config);       // 3. æå®šåˆ†æµè§„åˆ™
    overwriteProxyGroups(config); // 4. æå®šç­–ç•¥ç»„
    overwriteDns(config);         // 5. æå®š DNS
    addCustomRules(config);       // 2. æ’å…¥ä½ çš„ç§è´§

    return config;
}

// ================= 2. è‡ªå®šä¹‰è§„åˆ™ (è¿™æ˜¯ VIP å¿«é€Ÿé€šé“) =================
function addCustomRules(config) {
    const customRules = [
        // âœ… linux.doï¼šæœ¬åœ°å•æ¡è§„åˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        "DOMAIN-SUFFIX,linux.do,linux.do",
    ];
    config["rules"] = [...customRules, ...config["rules"]];
}

// ================= 3. è¦†å†™è§„åˆ™ & Providers =================
function overwriteRules(params) {
    const ruleUrlMap = {
        "LAN": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan_No_Resolve.yaml",

        // åŸ ChinaMax -> æ”¹åï¼šå›½å†…ç½‘ç«™
        "å›½å†…ç½‘ç«™": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaMax/ChinaMax_Classical_No_IPv6_No_Resolve.yaml",

        "SteamCN": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN_No_Resolve.yaml",
        "OpenAI": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI_No_Resolve.yaml",

        // âœ… Geminiï¼ˆNo_Resolve ç‰ˆæœ¬ï¼‰
        "Gemini": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Gemini/Gemini_No_Resolve.yaml",

        // âœ… GitHubï¼ˆNo_Resolve ç‰ˆæœ¬ï¼‰
        "GitHub": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/GitHub/GitHub_No_Resolve.yaml",

        "Google": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google_No_Resolve.yaml",
        "PayPal": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/PayPal/PayPal_No_Resolve.yaml",
        "Steam": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/Steam/Steam_No_Resolve.yaml",

        // åŸ GlobalMedia -> æ”¹åï¼šå…¨çƒåª’ä½“
        "å…¨çƒåª’ä½“": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/GlobalMedia/GlobalMedia_Classical_No_Resolve.yaml",

        // âœ… å¹¿å‘Šæ‹¦æˆªï¼šæœ€ç¨³å¦¥ç”¨ Classical_No_Resolve
        "å¹¿å‘Šæ‹¦æˆª": "https://raw.gitmirror.com/blackmatrix7/ios_rule_script/master/rule/Clash/AdvertisingLite/AdvertisingLite_Classical_No_Resolve.yaml",
    };

    const generatedProviders = {};
    Object.keys(RULE_CONFIG).forEach((key) => {
        if (ruleUrlMap[key]) {
            generatedProviders[key] = {
                type: "http",
                behavior: "classical",
                url: ruleUrlMap[key],
                path: `./ruleset/${key}.yaml`,
                interval: 86400,
                format: "yaml",
            };
        }
    });

    const optimizedRules = [
        // ---- æœ¬åœ° LAN å…œåº•ï¼ˆç¡¬è§„åˆ™ï¼Œä¸ä¾èµ–è¿œç¨‹ï¼‰----
        "IP-CIDR,10.0.0.0/8,DIRECT,no-resolve",
        "IP-CIDR,172.16.0.0/12,DIRECT,no-resolve",
        "IP-CIDR,192.168.0.0/16,DIRECT,no-resolve",
        "IP-CIDR,127.0.0.0/8,DIRECT,no-resolve",
        "IP-CIDR,169.254.0.0/16,DIRECT,no-resolve",
        "DOMAIN-SUFFIX,local,DIRECT",
        "DOMAIN-SUFFIX,lan,DIRECT",

        "RULE-SET,LAN,DIRECT,no-resolve",
        "RULE-SET,å¹¿å‘Šæ‹¦æˆª,å¹¿å‘Šæ‹¦æˆª,no-resolve",
        "RULE-SET,OpenAI,OpenAI,no-resolve",
        "RULE-SET,Gemini,Gemini,no-resolve",
        "RULE-SET,GitHub,GitHub,no-resolve",
        "RULE-SET,Google,Google,no-resolve",
        "RULE-SET,PayPal,PayPal,no-resolve",
        "RULE-SET,SteamCN,SteamCN,no-resolve",
        "RULE-SET,Steam,Steam,no-resolve",
        "RULE-SET,å…¨çƒåª’ä½“,å…¨çƒåª’ä½“,no-resolve",
        "RULE-SET,å›½å†…ç½‘ç«™,å›½å†…ç½‘ç«™,no-resolve",
        "MATCH," + PROXY_NAME,
    ];

    params["rule-providers"] = {
        ...(params["rule-providers"] || {}),
        ...generatedProviders,
    };
    params["rules"] = optimizedRules;
}

// ================= 4. è¦†å†™ä»£ç†ç»„ =================
function overwriteProxyGroups(params) {
    // âœ… å…¼å®¹ providerï¼šä¼˜å…ˆç”¨ main() é‡Œæ•´ç†å‡ºæ¥çš„åå­—
    const allProxies = params._allProxyNames || (params["proxies"] || []).map((e) => e.name);

    // 4.1 åœ°åŒºæ­£åˆ™ï¼ˆåŠ å…¥ . å’Œ @ ä½œä¸ºå¸¸è§åˆ†éš”ç¬¦ï¼Œé¿å…ä¸€äº›å‘½åå¯¼è‡´è¾¹ç•Œæ–­ä¸å¼€ï¼‰
    const regionFilterRegexs = [
        { name: "ğŸ‡­ğŸ‡° Hong Kong", regex: /é¦™æ¸¯|Hong[-\s_]*Kong|HongKong|ğŸ‡­ğŸ‡°|HKG|HK(\d+)?/i },
        { name: "ğŸ‡¸ğŸ‡¬ Singapore", regex: /æ–°åŠ å¡|ç‹®åŸ|Singapore|ğŸ‡¸ğŸ‡¬|SIN|SGP|SG(\d+)?/i },
        { name: "ğŸ‡¯ğŸ‡µ Japan", regex: /æ—¥æœ¬|Japan|ğŸ‡¯ğŸ‡µ|JPN|JP(\d+)?/i },
        { name: "ğŸ‡ºğŸ‡¸ United States", regex: /ç¾å›½|United\s*States|America|ğŸ‡ºğŸ‡¸|USA|US(\d+)?/i },
    ];

    const regionProxyGroups = regionFilterRegexs
        .map((item) => {
            const proxies = getProxiesByRegex(params, item.regex);
            return {
                name: item.name,
                type: "url-test",
                url: TEST_URL,
                interval: TEST_INTERVAL,
                tolerance: TEST_TOLERANCE,
                proxies,
                lazy: true,
            };
        })
        .filter((item) => item.proxies.length > 0);

    const regionGroupNames = regionProxyGroups.map((g) => g.name);

    const ruleSetProxyGroups = Object.keys(RULE_CONFIG).map((ruleSetName) => {
        const defaultStrategy = RULE_CONFIG[ruleSetName];
        let proxies;

        if (ruleSetName === "LAN") {
            proxies = ["DIRECT"];
        } else if (defaultStrategy === "DIRECT") {
            proxies = ["DIRECT", PROXY_NAME, ...regionGroupNames];
        } else if (defaultStrategy === "REJECT") {
            proxies = ["REJECT", "DIRECT", PROXY_NAME, ...regionGroupNames];
        } else {
            proxies = [PROXY_NAME, ...regionGroupNames, "DIRECT"];
        }

        return { name: ruleSetName, type: "select", proxies };
    });

    const autoSelect = {
        name: "ğŸŒ Auto",
        type: "url-test",
        url: TEST_URL,
        interval: TEST_INTERVAL,
        tolerance: TEST_TOLERANCE,
        proxies: [...allProxies],
        lazy: true,
    };

    const proxyGroup = {
        name: PROXY_NAME,
        type: "select",
        proxies: ["ğŸŒ Auto", ...regionGroupNames, ...allProxies, "DIRECT"],
    };

    params["proxy-groups"] = [
        proxyGroup,
        autoSelect,
        ...ruleSetProxyGroups,
        ...regionProxyGroups,
    ];
}

// ================= 5. è¦†å†™ DNS (æœ€ç»ˆå®‰å…¨ç‰ˆ - é˜²æ­¢ DNS æ³„éœ²) =================
function overwriteDns(params) {
    const cnDnsList = [
        "223.5.5.5", "223.6.6.6",
        "119.29.29.29", "119.28.28.28",
    ];
    const trustDnsList = [
        "https://cloudflare-dns.com/dns-query",
        "https://dns.google/dns-query",
        "https://1.1.1.1/dns-query",
        "https://8.8.4.4/dns-query",
    ];

    const dnsOptions = {
        "enable": true,
        "ipv6": false,
        "prefer-h3": true,

        "enhanced-mode": "fake-ip",
        "fake-ip-range": "198.18.0.1/16",

        "fake-ip-filter": [
            "*.lan",
            "*.local",
            "localhost",
            "localhost.*",
            "router.asus.com",
            "dns.msftncsi.com",
            "www.msftconnecttest.com",
            "time.*",
            "ntp.*",
            "id.qq.com",
        ],

        "default-nameserver": ["223.5.5.5", "119.29.29.29"],
        "nameserver": trustDnsList,

        "proxy-server-nameserver": cnDnsList,
        "respect-rules": true,

        "nameserver-policy": {
            "geosite:cn": cnDnsList,
            "geosite:geolocation-!cn": trustDnsList,
        },
    };

    const rawGeoxURLs = {
        "geoip": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat",
        "geosite": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat",
        "mmdb": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb",
    };
    const githubPrefix = "https://fastgh.lainbo.com/";
    const accelURLs = Object.fromEntries(
        Object.entries(rawGeoxURLs).map(([key, githubUrl]) => [
            key, `${githubPrefix}${githubUrl}`,
        ])
    );

    const otherOptions = {
        "unified-delay": true,
        "tcp-concurrent": true,
        "profile": { "store-selected": true, "store-fake-ip": true },
        "sniffer": {
            "enable": true,
            "sniff": {
                "TLS": { "ports": [443, 8443] },
                "HTTP": { "ports": [80, "8080-8880"], "override-destination": true }
            }
        },
        "geodata-mode": true,
        "geox-url": accelURLs,
    };

    params.dns = { ...params.dns, ...dnsOptions };
    Object.keys(otherOptions).forEach((key) => { params[key] = otherOptions[key]; });
}

// ================= è¾…åŠ©å‡½æ•° =================
function getProxiesByRegex(params, regex) {
    const names = params._allProxyNames || (params.proxies || []).map((e) => e.name);
    return names.filter((name) => regex.test(name));
}
